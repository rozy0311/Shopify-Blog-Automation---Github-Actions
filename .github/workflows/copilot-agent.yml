name: Copilot Coding Agent
# Disabled (user moved from VSCode Copilot to Cursor)
on:
  workflow_dispatch:
    inputs:
      task:
        description: "Task to execute"
        required: false
        default: "auto"

concurrency:
  group: copilot-agent-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write

env:
  BASE_BRANCH: ${{ github.event.repository.default_branch }}
  TASK_KEY: ${{ github.event_name == 'push' && github.ref_name || github.event.inputs.task || format('run-{0}', github.run_id) }}
  POLLINATIONS_NEGATIVE: "text, watermark, logo, signature"

jobs:
  copilot-agent:
    runs-on: ubuntu-latest
    if: ${{ github.actor != 'github-actions[bot]' }}
    name: copilot-agent

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install guardrail dependencies
        run: |
          pip install PyYAML

      - name: Run guardrail checks
        env:
          GUARDRAIL_REPORT_PATH: logs/guardrail-report.json
          GUARDRAIL_MODE: agent
        run: |
          python scripts/check_allowed_changes.py

      - name: Upload guardrail report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: guardrail-report-${{ github.run_id }}
          path: logs/guardrail-report.json

      - name: Create branch, commit, and push changes
        if: ${{ github.event_name != '' }}
        run: |
          if ! git status --porcelain | grep -q .; then
            echo "No changes to commit"
            echo "AGENT_BRANCH=" >> $GITHUB_ENV
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          TIMESTAMP=$(date -u +"%Y%m%d-%H%M%S")
          TASK_SLUG=$(echo "$TASK_KEY" | tr '[:upper:]' '[:lower:]' | sed -E 's/[^a-z0-9]+/-/g' | sed -E 's/^-+|-+$//g')
          if [ -z "$TASK_SLUG" ]; then
            TASK_SLUG="run-$TIMESTAMP"
          fi
          BRANCH="agent/tasks/$TASK_SLUG"

          if git ls-remote --exit-code --heads origin "$BRANCH" >/dev/null 2>&1; then
            git checkout -B "$BRANCH" "origin/$BRANCH"
          else
            git checkout -b "$BRANCH"
          fi
          echo "AGENT_BRANCH=$BRANCH" >> $GITHUB_ENV

          git add -A
          git commit -m "ðŸ¤– Copilot Agent: $TIMESTAMP"
          git push origin "$BRANCH"

      - name: Create pull request
        if: ${{ env.AGENT_BRANCH != '' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BASE_BRANCH: ${{ env.BASE_BRANCH }}
          AGENT_BRANCH: ${{ env.AGENT_BRANCH }}
          PR_SUMMARY: ${{ github.event.inputs.task || 'Automated copilot-agent run' }}
          GUARDRAIL_REPORT_PATH: logs/guardrail-report.json
          PR_LABELS: autonomous-agent
          PR_REVIEWERS: ${{ github.actor }}
          PR_SUMMARY_PATH: logs/pr-summary.md
          TASK_KEY: ${{ env.TASK_KEY }}
        run: |
          python scripts/create_pr.py

      - name: Publish PR step summary
        if: always()
        run: |
          if [ -f logs/pr-summary.md ]; then
            cat logs/pr-summary.md >> $GITHUB_STEP_SUMMARY
          fi
