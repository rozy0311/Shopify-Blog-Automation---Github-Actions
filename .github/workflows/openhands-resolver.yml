name: Auto-Assign Copilot Coding Agent
# =====================================================
# TỰ ĐỘNG 100% - Không cần làm gì!
#
# Cách dùng:
# 1. Tạo issue bất kỳ → Copilot tự động được assign
# 2. Hoặc comment '/copilot' → Copilot tự assign
# 3. Copilot sẽ tự implement và tạo PR
#
# KHÔNG CẦN API KEY - Dùng Copilot subscription có sẵn!
# =====================================================

on:
    issues:
        types: [opened, labeled]
    issue_comment:
        types: [created]

permissions:
    contents: write
    pull-requests: write
    issues: write

jobs:
    auto-assign-copilot:
        if: |
            (github.event_name == 'issues') ||
            (github.event_name == 'issue_comment' && contains(github.event.comment.body, '/copilot'))
        runs-on: ubuntu-latest
        steps:
            - name: Auto-assign Copilot to issue
              uses: actions/github-script@v7
              with:
                  script: |
                      const issueNumber = context.issue.number;

                      // Get current issue
                      const issue = await github.rest.issues.get({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        issue_number: issueNumber
                      });

                      // Check if already assigned
                      const assignees = issue.data.assignees.map(a => a.login.toLowerCase());
                      if (assignees.includes('copilot') || assignees.includes('github-copilot')) {
                        console.log('Copilot already assigned');
                        return;
                      }

                      // Auto-assign Copilot
                      try {
                        await github.rest.issues.addAssignees({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          issue_number: issueNumber,
                          assignees: ['copilot']
                        });
                        console.log('Copilot assigned successfully');

                        // Add comment
                        await github.rest.issues.createComment({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          issue_number: issueNumber,
                          body: `🤖 **Copilot đã được tự động assign!**\n\nCopilot sẽ:\n1. Phân tích issue này\n2. Viết code\n3. Tạo Pull Request\n\nBạn không cần làm gì cả - chờ PR thôi!`
                        });

                        // Add label
                        await github.rest.issues.addLabels({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          issue_number: issueNumber,
                          labels: ['copilot-assigned']
                        });
                      } catch (error) {
                        console.log('Could not assign Copilot:', error.message);
                        
                        // Fallback comment
                        await github.rest.issues.createComment({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          issue_number: issueNumber,
                          body: `🤖 **Copilot Coding Agent**\n\nVui lòng assign Copilot thủ công:\n1. Click **Assignees** bên phải\n2. Chọn **Copilot**\n\nHoặc dùng Copilot Chat: \`@github-copilot /fix #${issueNumber}\``
                        });
                      }
