name: Shopify Blog Executor
run-name: Shopify Blog Executor (${{ github.event_name == 'workflow_dispatch' && github.event.inputs.mode != '' && github.event.inputs.mode || (vars.WF_ENABLED == 'true' && vars.ALLOW_PUBLISH == 'human_enabled' && 'publish' || 'review') }})

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "Execution mode"
        required: false
        default: review
        type: choice
        options:
          - review
          - publish
      start_at:
        description: "1-based index (1, 31, 61, ...)"
        required: false
        default: "1"
        type: string
      max_items:
        description: "Batch size"
        required: false
        default: "1"
        type: string
      reason:
        description: "Why are you running this?"
        required: false
        default: Manual dispatch
        type: string
  schedule:
    - cron: "*/10 * * * *" # every 10 minutes (UTC)

concurrency:
  group: executor
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install guardrail dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install PyYAML
      - name: Export configuration
        run: |
          {
            echo "SHEETS_ID=${{ vars.SHEETS_ID }}"
            echo "SHEETS_RANGE=${{ vars.SHEETS_RANGE }}"
            echo "CONFIG_RANGE=${{ vars.CONFIG_RANGE }}"
            echo "SHOPIFY_SHOP=${{ vars.SHOPIFY_SHOP }}"
            echo "BLOG_HANDLE=${{ vars.BLOG_HANDLE }}"
            echo "AUTHOR=${{ vars.AUTHOR }}"
            echo "OPENAI_MODEL=${{ vars.OPENAI_MODEL }}"
            echo "GH_MODELS_API_BASE=${{ vars.GH_MODELS_API_BASE || 'https://models.github.ai/inference' }}"
            echo "GH_MODELS_MODEL=${{ vars.GH_MODELS_MODEL }}"
            echo "GEMINI_MODEL=${{ vars.GEMINI_MODEL || 'gemini-1.5-flash' }}"
            echo "LLM_PROVIDER_ORDER=${{ vars.LLM_PROVIDER_ORDER || 'gemini,github_models,openai' }}"
            echo "DISABLE_OPENAI=${{ vars.DISABLE_OPENAI || 'true' }}"
            echo "CONFIG_FILE=${{ vars.CONFIG_FILE }}"
            echo "QUEUE_FILE=${{ vars.QUEUE_FILE }}"
            echo "QUEUE_URL=${{ vars.QUEUE_URL }}"
            echo "LOCAL_HEARTBEAT_FILE=${{ vars.LOCAL_HEARTBEAT_FILE || 'local_heartbeat.json' }}"
            echo "LOCAL_HEARTBEAT_URL=${{ vars.LOCAL_HEARTBEAT_URL }}"
            echo "LOCAL_HEARTBEAT_MAX_AGE_MINUTES=${{ vars.LOCAL_HEARTBEAT_MAX_AGE_MINUTES || '15' }}"
            echo "SHEETS_ENABLED=${{ vars.SHEETS_ENABLED || 'true' }}"
            echo "WF_ENABLED=${{ vars.WF_ENABLED }}"
            echo "ALLOW_PUBLISH=${{ vars.ALLOW_PUBLISH }}"
            echo "MODE=${{ github.event_name == 'workflow_dispatch' && github.event.inputs.mode != '' && github.event.inputs.mode || (vars.WF_ENABLED == 'true' && vars.ALLOW_PUBLISH == 'human_enabled' && 'publish' || 'review') }}"
            echo "DISPATCH_REASON=${{ github.event_name == 'workflow_dispatch' && github.event.inputs.reason || format('auto run {0}', github.run_id) }}"
          } >> "$GITHUB_ENV"
      - name: Export batch window
        run: |
          echo "START_AT=${{ github.event_name == 'workflow_dispatch' && github.event.inputs.start_at != '' && github.event.inputs.start_at || vars.START_AT || '1' }}" >> "$GITHUB_ENV"
          echo "MAX_ITEMS=${{ github.event_name == 'workflow_dispatch' && github.event.inputs.max_items != '' && github.event.inputs.max_items || vars.MAX_ITEMS || '1' }}" >> "$GITHUB_ENV"
      - name: Inject secrets
        run: |
          {
            echo "SHOPIFY_TOKEN=${{ secrets.SHOPIFY_ACCESS_TOKEN }}"
            echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}"
            echo "GH_MODELS_API_KEY=${{ secrets.GH_MODELS_API_KEY || secrets.GITHUB_TOKEN }}"
            echo "GITHUB_MODELS_API_KEY=${{ secrets.GITHUB_MODELS_API_KEY || secrets.GITHUB_TOKEN }}"
            echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}"
          } >> "$GITHUB_ENV"
      - name: Install dependencies
        run: npm ci
      - name: Google creds -> file (for Sheets ADC)
        shell: bash
        env:
          GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
        run: |
          if [ -n "$GOOGLE_SERVICE_ACCOUNT_JSON" ]; then
            echo "$GOOGLE_SERVICE_ACCOUNT_JSON" > $RUNNER_TEMP/google-credentials.json
            echo "GOOGLE_APPLICATION_CREDENTIALS=$RUNNER_TEMP/google-credentials.json" >> $GITHUB_ENV
            echo "SHEETS_ENABLED=true" >> $GITHUB_ENV
          else
            echo "WARNING: Missing secret GOOGLE_SERVICE_ACCOUNT_JSON; Sheets updates disabled."
            echo "SHEETS_ENABLED=false" >> $GITHUB_ENV
          fi
      - name: Build executor
        run: npm run --workspace apps/executor build
      - name: Check local heartbeat
        run: |
          set -euo pipefail
          max_age_min="${LOCAL_HEARTBEAT_MAX_AGE_MINUTES:-15}"
          heartbeat_ts=""
          if [ -n "${LOCAL_HEARTBEAT_URL:-}" ]; then
            echo "Checking heartbeat URL: $LOCAL_HEARTBEAT_URL"
            heartbeat_ts=$(python -c "import json, os, urllib.request; url=os.environ.get('LOCAL_HEARTBEAT_URL','');\ntry:\n  resp=urllib.request.urlopen(url,timeout=10)\n  data=json.loads(resp.read().decode('utf-8'))\n  print(str(data.get('timestamp','')).strip())\nexcept Exception:\n  print('', end='')\n")
          elif [ -f "${LOCAL_HEARTBEAT_FILE:-local_heartbeat.json}" ]; then
            echo "Checking heartbeat file: ${LOCAL_HEARTBEAT_FILE:-local_heartbeat.json}"
            heartbeat_ts=$(python -c "import json, os; path=os.environ.get('LOCAL_HEARTBEAT_FILE','local_heartbeat.json');\ntry:\n  data=json.load(open(path,'r',encoding='utf-8'))\n  print(str(data.get('timestamp','')).strip())\nexcept Exception:\n  print('', end='')\n")
          fi

          active="false"
          if [ -n "$heartbeat_ts" ]; then
            now=$(date +%s)
            age=$((now - heartbeat_ts))
            max_age_sec=$((max_age_min * 60))
            if [ "$age" -ge 0 ] && [ "$age" -le "$max_age_sec" ]; then
              active="true"
            fi
            echo "Heartbeat age: ${age}s (max ${max_age_sec}s)"
          fi
          echo "LOCAL_HEARTBEAT_ACTIVE=$active" >> "$GITHUB_ENV"
          if [ "$active" = "true" ]; then
            echo "Local runner active; skipping executor run."
          fi
      - name: Run executor (${{ env.MODE }}) - fresh session per blog (single item)
        if: env.LOCAL_HEARTBEAT_ACTIVE != 'true'
        env:
          MODE: ${{ env.MODE }}
          DISPATCH_REASON: ${{ env.DISPATCH_REASON }}
        run: |
          set -euo pipefail
          total=${MAX_ITEMS:-1}
          start=${START_AT:-1}
          i=0
          while [ $i -lt $total ]; do
            export START_AT=$((start + i))
            export MAX_ITEMS=1
            echo "Running executor item $((i+1))/$total (START_AT=$START_AT, MAX_ITEMS=$MAX_ITEMS)"
            node apps/executor/dist/index.js
            i=$((i+1))
          done
      - name: Upload previews + summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: executor-artifacts-${{ github.run_id }}
          if-no-files-found: ignore
          retention-days: 7
          path: |
            apps/executor/out/**
            out/**

      - name: Guardrail check
        if: always()
        env:
          EXTRA_ALLOWED_PATHS: apps/executor/out/,out/
        run: |
          if [ -f "scripts/check_allowed_changes.py" ]; then
            python scripts/check_allowed_changes.py
          else
            echo "Guardrail script missing; skipping guardrail check."
          fi
