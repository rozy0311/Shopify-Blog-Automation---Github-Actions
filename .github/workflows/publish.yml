name: Shopify Blog Executor
run-name: Shopify Blog Executor (${{ github.event_name == 'workflow_dispatch' && github.event.inputs.mode != '' && github.event.inputs.mode || (vars.WF_ENABLED == 'true' && vars.ALLOW_PUBLISH == 'human_enabled' && 'publish' || 'review') }})

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "Execution mode"
        required: false
        default: review
        type: choice
        options:
          - review
          - publish
      start_at:
        description: "1-based index (1, 31, 61, ...)"
        required: false
        default: "1"
        type: string
      max_items:
        description: "Batch size"
        required: false
        default: "30"
        type: string
      reason:
        description: "Why are you running this?"
        required: false
        default: Manual dispatch
        type: string
  schedule:
    - cron: "5 13,19,2 * * *" # 07:05, 13:05, 20:05 America/Chicago (UTC times)

concurrency:
  group: executor
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install guardrail dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install PyYAML
      - name: Export configuration
        run: |
          {
            echo "SHEETS_ID=${{ vars.SHEETS_ID }}"
            echo "SHEETS_RANGE=${{ vars.SHEETS_RANGE }}"
            echo "CONFIG_RANGE=${{ vars.CONFIG_RANGE }}"
            echo "SHOPIFY_SHOP=${{ vars.SHOPIFY_SHOP }}"
            echo "BLOG_HANDLE=${{ vars.BLOG_HANDLE }}"
            echo "AUTHOR=${{ vars.AUTHOR }}"
            echo "OPENAI_MODEL=${{ vars.OPENAI_MODEL }}"
            echo "WF_ENABLED=${{ vars.WF_ENABLED }}"
            echo "ALLOW_PUBLISH=${{ vars.ALLOW_PUBLISH }}"
            echo "MODE=${{ github.event_name == 'workflow_dispatch' && github.event.inputs.mode != '' && github.event.inputs.mode || (vars.WF_ENABLED == 'true' && vars.ALLOW_PUBLISH == 'human_enabled' && 'publish' || 'review') }}"
            echo "DISPATCH_REASON=${{ github.event_name == 'workflow_dispatch' && github.event.inputs.reason || format('auto run {0}', github.run_id) }}"
          } >> "$GITHUB_ENV"
      - name: Export batch window
        run: |
          echo "START_AT=${{ github.event_name == 'workflow_dispatch' && github.event.inputs.start_at != '' && github.event.inputs.start_at || vars.START_AT || '1' }}" >> "$GITHUB_ENV"
          echo "MAX_ITEMS=${{ github.event_name == 'workflow_dispatch' && github.event.inputs.max_items != '' && github.event.inputs.max_items || vars.MAX_ITEMS || '30' }}" >> "$GITHUB_ENV"
      - name: Inject secrets
        run: |
          {
            echo "SHOPIFY_TOKEN=${{ secrets.SHOPIFY_ACCESS_TOKEN }}"
            echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}"
          } >> "$GITHUB_ENV"
      - name: Install dependencies
        run: npm ci
      - name: Google creds -> file (for Sheets ADC)
        shell: bash
        env:
          GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
        run: |
          if [ -n "$GOOGLE_SERVICE_ACCOUNT_JSON" ]; then
            echo "$GOOGLE_SERVICE_ACCOUNT_JSON" > $RUNNER_TEMP/google-credentials.json
            echo "GOOGLE_APPLICATION_CREDENTIALS=$RUNNER_TEMP/google-credentials.json" >> $GITHUB_ENV
          else
            echo "ERROR: Missing secret GOOGLE_SERVICE_ACCOUNT_JSON"
            exit 1
          fi
      - name: Build executor
        run: npm run --workspace apps/executor build
      - name: Run executor (${{ env.MODE }}) - fresh session per blog
        env:
          MODE: ${{ env.MODE }}
          DISPATCH_REASON: ${{ env.DISPATCH_REASON }}
        run: |
          set -euo pipefail
          total=${MAX_ITEMS:-1}
          start=${START_AT:-1}
          i=0
          while [ $i -lt $total ]; do
            export START_AT=$((start + i))
            export MAX_ITEMS=1
            echo "Running executor item $((i+1))/$total (START_AT=$START_AT, MAX_ITEMS=$MAX_ITEMS)"
            node apps/executor/dist/index.js
            i=$((i+1))
          done
      - name: Upload previews + summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: executor-artifacts-${{ github.run_id }}
          if-no-files-found: ignore
          retention-days: 7
          path: |
            apps/executor/out/**
            out/**

      - name: Guardrail check
        if: always()
        env:
          EXTRA_ALLOWED_PATHS: apps/executor/out/,out/
        run: |
          python scripts/check_allowed_changes.py
