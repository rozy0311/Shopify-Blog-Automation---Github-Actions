name: Article Pre-Publish Review

on:
  workflow_dispatch:
    inputs:
      article_id:
        description: "Single Shopify article ID to review"
        required: true
        type: string

permissions:
  contents: read

env:
  MAX_ATTEMPTS_PER_ARTICLE: "3"

jobs:
  review:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      SHOPIFY_SHOP: ${{ secrets.SHOPIFY_SHOP }}
      SHOPIFY_ACCESS_TOKEN: ${{ secrets.SHOPIFY_ACCESS_TOKEN }}
      SHOPIFY_BLOG_ID: ${{ secrets.SHOPIFY_BLOG_ID }}
      SHOPIFY_API_VERSION: ${{ secrets.SHOPIFY_API_VERSION }}
      POLLINATIONS_API_KEY: ${{ secrets.POLLINATIONS_API_KEY }}
      GOOGLE_AI_StUDIO_API_KEY: ${{ secrets.GOOGLE_AI_STUDIO_API_KEY }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      GEMINI_MODEL: ${{ vars.GEMINI_MODEL || 'gemini-2.0-flash' }}
      GH_MODELS_API_KEY: ${{ secrets.GH_MODELS_API_KEY || secrets.GITHUB_TOKEN }}
      GH_MODELS_MODEL: ${{ vars.GH_MODELS_MODEL || 'openai/gpt-4.1' }}
      VISION_REVIEW: "0"
      VISION_API_KEY: ${{ secrets.VISION_API_KEY }}
      MAX_ATTEMPTS_PER_ARTICLE: "3"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: python -m pip install --upgrade pip && pip install requests PyYAML python-dotenv beautifulsoup4 google-auth pillow

      - name: Set agent dir
        id: agent_dir
        run: |
          SUB="Agent - Pinterest -Shopify Blog Autopilot - End-to-End Content Factory"
          if [ -f "$SUB/pipeline_v2/publish_now_graphql.py" ]; then
            echo "dir=$SUB" >> $GITHUB_OUTPUT
            echo "pipeline_dir=$SUB/pipeline_v2" >> $GITHUB_OUTPUT
          elif [ -f "pipeline_v2/publish_now_graphql.py" ]; then
            echo "dir=." >> $GITHUB_OUTPUT
            echo "pipeline_dir=pipeline_v2" >> $GITHUB_OUTPUT
          else
            echo "dir=." >> $GITHUB_OUTPUT
            echo "pipeline_dir=pipeline_v2" >> $GITHUB_OUTPUT
          fi

      - name: Review and fix loop (max 3 attempts)
        id: review_loop
        shell: bash
        env:
          SHOPIFY_SHOP: ${{ secrets.SHOPIFY_SHOP }}
          SHOPIFY_ACCESS_TOKEN: ${{ secrets.SHOPIFY_ACCESS_TOKEN }}
          SHOPIFY_BLOG_ID: ${{ secrets.SHOPIFY_BLOG_ID }}
          SHOPIFY_API_VERSION: ${{ secrets.SHOPIFY_API_VERSION }}
          POLLINATIONS_API_KEY: ${{ secrets.POLLINATIONS_API_KEY }}
          GET_POLLINATIONS_URL: ${{ secrets.GET_POLLINATIONS_URL }}
          GOOGLE_AI_StUDIO_API_KEY: ${{ secrets.GOOGLE_AI_STUDIO_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_MODEL: ${{ vars.GEMINI_MODEL || 'gemini-2.0-flash' }}
          GH_MODELS_API_KEY: ${{ secrets.GH_MODELS_API_KEY || secrets.GITHUB_TOKEN }}
          GH_MODELS_MODEL: ${{ vars.GH_MODELS_MODEL || 'openai/gpt-4.1' }}
          VISION_REVIEW: "0"
          VISION_API_KEY: ${{ secrets.VISION_API_KEY }}
        run: |
          set +e
          article_id="${{ inputs.article_id }}"
          agent_dir="${{ steps.agent_dir.outputs.dir }}"
          pipeline_dir="${{ steps.agent_dir.outputs.pipeline_dir }}"
          max_attempts=${MAX_ATTEMPTS_PER_ARTICLE:-3}
          attempt=1
          review_passed=0

          while [ "$attempt" -le "$max_attempts" ] && [ "$review_passed" -eq 0 ]; do
              echo "========================================"
              echo "[Attempt $attempt/$max_attempts] Reviewing article $article_id..."
              echo "========================================"

              # Run pre-publish review
              python "$agent_dir/scripts/pre_publish_review.py" "$article_id" 2>&1 | tee "review-output-attempt-$attempt.txt"
              EXIT=${PIPESTATUS[0]}

              if [ "$EXIT" -eq 0 ]; then
                  echo "✅ Review PASSED on attempt $attempt"
                  review_passed=1
                  echo "review_passed=true" >> $GITHUB_OUTPUT
                  echo "final_attempt=$attempt" >> $GITHUB_OUTPUT
                  break
              fi

              echo "❌ Review failed on attempt $attempt (exit=$EXIT)"

              if [ "$attempt" -lt "$max_attempts" ]; then
                  echo "Attempting fix..."
                  if [ "$attempt" -eq 1 ]; then
                      # First retry: quick fix content + images
                      python "$pipeline_dir/ai_orchestrator.py" fix-ids "$article_id" 2>&1 | tee "fix-output-attempt-$attempt.txt"
                      python "$pipeline_dir/fix_images_properly.py" --article-id "$article_id" 2>&1 | tee "fix-images-attempt-$attempt.txt" || true
                  else
                      # Subsequent retries: force rebuild + images
                      python "$pipeline_dir/ai_orchestrator.py" force-rebuild-ids "$article_id" 2>&1 | tee "rebuild-output-attempt-$attempt.txt"
                      python "$pipeline_dir/fix_images_properly.py" --article-id "$article_id" 2>&1 | tee "fix-images-attempt-$attempt.txt" || true
                  fi
                  echo "Waiting 30s before next attempt..."
                  sleep 30
              fi

              attempt=$((attempt + 1))
          done

          if [ "$review_passed" -eq 0 ]; then
              echo "❌ All $max_attempts attempts exhausted. Article $article_id did not pass review."
              echo "review_passed=false" >> $GITHUB_OUTPUT
              echo "final_attempt=$max_attempts" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Publish to Shopify (cleanup + set featured + publish)
        if: steps.review_loop.outputs.review_passed == 'true'
        working-directory: Agent - Pinterest -Shopify Blog Autopilot - End-to-End Content Factory
        env:
          SHOPIFY_SHOP: ${{ secrets.SHOPIFY_SHOP }}
          SHOPIFY_STORE_DOMAIN: ${{ secrets.SHOPIFY_SHOP }}
          SHOPIFY_ACCESS_TOKEN: ${{ secrets.SHOPIFY_ACCESS_TOKEN }}
          SHOPIFY_BLOG_ID: ${{ secrets.SHOPIFY_BLOG_ID }}
          SHOPIFY_API_VERSION: ${{ secrets.SHOPIFY_API_VERSION }}
        run: |
          python pipeline_v2/cleanup_before_publish.py "${{ inputs.article_id }}"
          python pipeline_v2/set_featured_image_if_missing.py "${{ inputs.article_id }}"
          python pipeline_v2/publish_now_graphql.py "${{ inputs.article_id }}"
          echo "Publish step finished for ${{ inputs.article_id }}"

      - name: Export article body for verification
        if: steps.review_loop.outputs.review_passed == 'true'
        working-directory: Agent - Pinterest -Shopify Blog Autopilot - End-to-End Content Factory
        env:
          SHOPIFY_SHOP: ${{ secrets.SHOPIFY_SHOP }}
          SHOPIFY_ACCESS_TOKEN: ${{ secrets.SHOPIFY_ACCESS_TOKEN }}
          SHOPIFY_BLOG_ID: ${{ secrets.SHOPIFY_BLOG_ID }}
          SHOPIFY_API_VERSION: ${{ secrets.SHOPIFY_API_VERSION }}
        run: |
          python - <<'PY'
          import os, requests
          from bs4 import BeautifulSoup
          article_id = "${{ inputs.article_id }}"
          shop = os.environ.get("SHOPIFY_SHOP")
          token = os.environ.get("SHOPIFY_ACCESS_TOKEN")
          blog_id = os.environ.get("SHOPIFY_BLOG_ID")
          api_ver = os.environ.get("SHOPIFY_API_VERSION", "2025-01")
          url = f"https://{shop}/admin/api/{api_ver}/blogs/{blog_id}/articles/{article_id}.json"
          r = requests.get(url, headers={"X-Shopify-Access-Token": token, "Content-Type": "application/json"})
          r.raise_for_status()
          article = r.json().get("article") or {}
          body_html = article.get("body_html") or ""
          with open("article-body.html", "w", encoding="utf-8") as f:
              f.write(body_html)
          text = BeautifulSoup(body_html, "html.parser").get_text("\n", strip=True)
          with open("article-body.txt", "w", encoding="utf-8") as f:
              f.write(text)
          print("Exported article-body.html and article-body.txt")
          PY

      - name: Fail if no review passed (block publish when meta-prompt not met)
        if: steps.review_loop.outputs.review_passed != 'true'
        run: |
          echo "Pre-publish review did not pass after ${{ steps.review_loop.outputs.final_attempt }} attempts (meta-prompt not met). Not publishing."
          exit 1

      - name: Upload review output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pre-publish-review-${{ inputs.article_id }}
          path: |
            review-output-attempt-*.txt
            fix-output-attempt-*.txt
            rebuild-output-attempt-*.txt
            Agent - Pinterest -Shopify Blog Autopilot - End-to-End Content Factory/article-body.html
            Agent - Pinterest -Shopify Blog Autopilot - End-to-End Content Factory/article-body.txt
          if-no-files-found: ignore
          retention-days: 7

      - name: Review summary
        if: always()
        run: |
          echo "## Pre-Publish Review" >> $GITHUB_STEP_SUMMARY
          echo "- Article ID: ${{ inputs.article_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- Timestamp: $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "- Review Passed: ${{ steps.review_loop.outputs.review_passed || 'unknown' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Final Attempt: ${{ steps.review_loop.outputs.final_attempt || 'unknown' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Max Attempts: ${MAX_ATTEMPTS_PER_ARTICLE:-3}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Output (last attempt)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          for f in review-output-attempt-*.txt; do
            if [ -f "$f" ]; then
              echo "#### $f" >> $GITHUB_STEP_SUMMARY
              tail -n 100 "$f" >> $GITHUB_STEP_SUMMARY
            fi
          done

      - name: Guardrail check
        if: always()
        continue-on-error: true
        env:
          EXTRA_ALLOWED_PATHS: review-output.txt,review-output-after-fix.txt,review-output-after-rebuild.txt
        run: |
          if [ -f "scripts/check_allowed_changes.py" ]; then
            python scripts/check_allowed_changes.py || echo "Guardrail exited non-zero, continuing."
          else
            echo "Guardrail script not found at scripts/check_allowed_changes.py, skipping."
          fi
