name: Article Pre-Publish Review

on:
    workflow_dispatch:
        inputs:
            article_id:
                description: "Single Shopify article ID to review"
                required: true
                type: string

permissions:
    contents: read

jobs:
    review:
        runs-on: ubuntu-latest
        env:
            SHOPIFY_SHOP: ${{ secrets.SHOPIFY_SHOP }}
            SHOPIFY_ACCESS_TOKEN: ${{ secrets.SHOPIFY_ACCESS_TOKEN }}
            SHOPIFY_BLOG_ID: ${{ secrets.SHOPIFY_BLOG_ID }}
            SHOPIFY_API_VERSION: ${{ secrets.SHOPIFY_API_VERSION }}
            POLLINATIONS_API_KEY: ${{ secrets.POLLINATIONS_API_KEY }}
            VISION_REVIEW: "1"
            VISION_API_KEY: ${{ secrets.VISION_API_KEY }}
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"

            - name: Install dependencies
              run: python -m pip install --upgrade pip && pip install requests PyYAML python-dotenv beautifulsoup4 google-auth pillow

            - name: Set agent dir
              id: agent_dir
              run: |
                  SUB="Agent - Pinterest -Shopify Blog Autopilot - End-to-End Content Factory"
                  if [ -f "$SUB/pipeline_v2/publish_now_graphql.py" ]; then
                    echo "dir=$SUB" >> $GITHUB_OUTPUT
                    echo "pipeline_dir=$SUB/pipeline_v2" >> $GITHUB_OUTPUT
                  elif [ -f "pipeline_v2/publish_now_graphql.py" ]; then
                    echo "dir=." >> $GITHUB_OUTPUT
                    echo "pipeline_dir=pipeline_v2" >> $GITHUB_OUTPUT
                  else
                    echo "dir=." >> $GITHUB_OUTPUT
                    echo "pipeline_dir=pipeline_v2" >> $GITHUB_OUTPUT
                  fi

            - name: Run pre-publish review (initial)
              shell: bash
              env:
                  SHOPIFY_SHOP: ${{ secrets.SHOPIFY_SHOP }}
                  SHOPIFY_ACCESS_TOKEN: ${{ secrets.SHOPIFY_ACCESS_TOKEN }}
                  SHOPIFY_BLOG_ID: ${{ secrets.SHOPIFY_BLOG_ID }}
                  SHOPIFY_API_VERSION: ${{ secrets.SHOPIFY_API_VERSION }}
                  VISION_REVIEW: "1"
                  VISION_API_KEY: ${{ secrets.VISION_API_KEY }}
              run: |
                  set +e
                  python "${{ steps.agent_dir.outputs.dir }}/scripts/pre_publish_review.py" "${{ inputs.article_id }}" 2>&1 | tee review-output.txt
                  EXIT=${PIPESTATUS[0]}
                  echo "review_status=$EXIT" >> $GITHUB_OUTPUT
              id: review_initial
              continue-on-error: true

            - name: Auto-fix on review failure
              if: ${{ steps.review_initial.outputs.review_status != '0' }}
              working-directory: ${{ steps.agent_dir.outputs.pipeline_dir }}
              run: |
                  python ai_orchestrator.py fix-ids "${{ inputs.article_id }}"

            - name: Run pre-publish review (after fix)
              if: ${{ steps.review_initial.outputs.review_status != '0' }}
              shell: bash
              env:
                  SHOPIFY_SHOP: ${{ secrets.SHOPIFY_SHOP }}
                  SHOPIFY_ACCESS_TOKEN: ${{ secrets.SHOPIFY_ACCESS_TOKEN }}
                  SHOPIFY_BLOG_ID: ${{ secrets.SHOPIFY_BLOG_ID }}
                  SHOPIFY_API_VERSION: ${{ secrets.SHOPIFY_API_VERSION }}
                  VISION_REVIEW: "1"
                  VISION_API_KEY: ${{ secrets.VISION_API_KEY }}
              run: |
                  set +e
                  python "${{ steps.agent_dir.outputs.dir }}/scripts/pre_publish_review.py" "${{ inputs.article_id }}" 2>&1 | tee review-output-after-fix.txt
                  EXIT=${PIPESTATUS[0]}
                  echo "review_status_after=$EXIT" >> $GITHUB_OUTPUT
              id: review_after
              continue-on-error: true

            - name: Force rebuild on review failure
              if: ${{ steps.review_after.outputs.review_status_after == '1' }}
              working-directory: ${{ steps.agent_dir.outputs.pipeline_dir }}
              run: |
                  python ai_orchestrator.py force-rebuild-ids "${{ inputs.article_id }}"

            - name: Run pre-publish review (after rebuild)
              if: ${{ steps.review_after.outputs.review_status_after == '1' }}
              shell: bash
              env:
                  SHOPIFY_SHOP: ${{ secrets.SHOPIFY_SHOP }}
                  SHOPIFY_ACCESS_TOKEN: ${{ secrets.SHOPIFY_ACCESS_TOKEN }}
                  SHOPIFY_BLOG_ID: ${{ secrets.SHOPIFY_BLOG_ID }}
                  SHOPIFY_API_VERSION: ${{ secrets.SHOPIFY_API_VERSION }}
                  VISION_REVIEW: "1"
                  VISION_API_KEY: ${{ secrets.VISION_API_KEY }}
              run: |
                  set +e
                  python "${{ steps.agent_dir.outputs.dir }}/scripts/pre_publish_review.py" "${{ inputs.article_id }}" 2>&1 | tee review-output-after-rebuild.txt
                  EXIT=${PIPESTATUS[0]}
                  echo "review_status_after_rebuild=$EXIT" >> $GITHUB_OUTPUT
              id: review_after_rebuild
              continue-on-error: true

            - name: Set publish-allowed (only when at least one review passed)
              id: publish_ok
              run: |
                  INIT="${{ steps.review_initial.outputs.review_status }}"
                  AFTER="${{ steps.review_after.outputs.review_status_after }}"
                  REBUILD="${{ steps.review_after_rebuild.outputs.review_status_after_rebuild }}"
                  if [ "$INIT" = "0" ] || [ "$AFTER" = "0" ] || [ "$REBUILD" = "0" ]; then
                    echo "allowed=true" >> $GITHUB_OUTPUT
                  else
                    echo "allowed=false" >> $GITHUB_OUTPUT
                  fi

            - name: Publish to Shopify (cleanup + set featured + publish)
              if: steps.publish_ok.outputs.allowed == 'true'
              working-directory: Agent - Pinterest -Shopify Blog Autopilot - End-to-End Content Factory
              env:
                  SHOPIFY_SHOP: ${{ secrets.SHOPIFY_SHOP }}
                  SHOPIFY_STORE_DOMAIN: ${{ secrets.SHOPIFY_SHOP }}
                  SHOPIFY_ACCESS_TOKEN: ${{ secrets.SHOPIFY_ACCESS_TOKEN }}
                  SHOPIFY_BLOG_ID: ${{ secrets.SHOPIFY_BLOG_ID }}
                  SHOPIFY_API_VERSION: ${{ secrets.SHOPIFY_API_VERSION }}
              run: |
                  python pipeline_v2/cleanup_before_publish.py "${{ inputs.article_id }}"
                  python pipeline_v2/set_featured_image_if_missing.py "${{ inputs.article_id }}"
                  python pipeline_v2/publish_now_graphql.py "${{ inputs.article_id }}"
                  echo "Publish step finished for ${{ inputs.article_id }}"

            - name: Fail if no review passed (block publish when meta-prompt not met)
              if: steps.publish_ok.outputs.allowed != 'true'
              run: |
                  echo "Pre-publish review did not pass (meta-prompt not met). Not publishing."
                  exit 1

            - name: Upload review output
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: pre-publish-review-${{ inputs.article_id }}
                  path: |
                      review-output.txt
                      review-output-after-fix.txt
                      review-output-after-rebuild.txt
                  if-no-files-found: ignore
                  retention-days: 7

            - name: Review summary
              if: always()
              run: |
                  echo "## Pre-Publish Review" >> $GITHUB_STEP_SUMMARY
                  echo "- Article ID: ${{ inputs.article_id }}" >> $GITHUB_STEP_SUMMARY
                  echo "- Timestamp: $(date -u)" >> $GITHUB_STEP_SUMMARY
                  echo "- Initial Review Status: ${{ steps.review_initial.outputs.review_status || 'unknown' }}" >> $GITHUB_STEP_SUMMARY
                  echo "- After Fix Review Status: ${{ steps.review_after.outputs.review_status_after || 'unknown' }}" >> $GITHUB_STEP_SUMMARY
                  echo "- After Rebuild Review Status: ${{ steps.review_after_rebuild.outputs.review_status_after_rebuild || 'unknown' }}" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### Output (tail)" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  (tail -n 200 review-output-after-rebuild.txt 2>/dev/null || tail -n 200 review-output-after-fix.txt 2>/dev/null || tail -n 200 review-output.txt 2>/dev/null || echo "No review output files found") >> $GITHUB_STEP_SUMMARY

            - name: Guardrail check
              if: always()
              continue-on-error: true
              env:
                  EXTRA_ALLOWED_PATHS: review-output.txt,review-output-after-fix.txt,review-output-after-rebuild.txt
              run: |
                  if [ -f "scripts/check_allowed_changes.py" ]; then
                    python scripts/check_allowed_changes.py || echo "Guardrail exited non-zero, continuing."
                  else
                    echo "Guardrail script not found at scripts/check_allowed_changes.py, skipping."
                  fi
