name: re-audit-dispatch

on:
    workflow_dispatch:
        inputs:
            limit:
                description: "Max articles to audit"
                required: false
                default: "250"
    schedule:
        - cron: "0 2 * * *"

jobs:
    audit:
        runs-on: ubuntu-latest
        permissions:
            contents: read
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install requests

            - name: Run quality audit
              env:
                  SHOPIFY_SHOP: ${{ secrets.SHOPIFY_SHOP }}
                  SHOPIFY_ACCESS_TOKEN: ${{ secrets.SHOPIFY_ACCESS_TOKEN }}
                  SHOPIFY_BLOG_ID: ${{ secrets.SHOPIFY_BLOG_ID }}
                  SHOPIFY_API_VERSION: ${{ secrets.SHOPIFY_API_VERSION }}
              run: |
                  python scripts/quality_agent.py --limit ${{ inputs.limit }} --export

            - name: Run meta-prompt content audit
              env:
                  SHOPIFY_SHOP: ${{ secrets.SHOPIFY_SHOP }}
                  SHOPIFY_ACCESS_TOKEN: ${{ secrets.SHOPIFY_ACCESS_TOKEN }}
                  SHOPIFY_BLOG_ID: ${{ secrets.SHOPIFY_BLOG_ID }}
                  SHOPIFY_API_VERSION: ${{ secrets.SHOPIFY_API_VERSION }}
              run: |
                  python scripts/meta_prompt_quality_agent.py --limit ${{ inputs.limit }} --export

            - name: Upload audit report
              uses: actions/upload-artifact@v4
              with:
                  name: quality-report
                  path: |
                      quality_report_*.json
                      meta_prompt_quality_report_*.json
                  if-no-files-found: error
