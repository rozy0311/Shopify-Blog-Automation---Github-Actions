name: Restore From Backups

on:
  workflow_dispatch:
    inputs:
      limit:
        description: "Max number of articles to restore"
        required: false
        default: "20"
      ids:
        description: "Comma-separated article IDs (optional)"
        required: false
        default: ""
      force:
        description: "Force restore even if current passes review"
        required: false
        default: "false"
      keep_failed:
        description: "Keep backup even if it fails review"
        required: false
        default: "false"
      dry_run:
        description: "Do not write to Shopify"
        required: false
        default: "false"

concurrency:
  group: restore-from-backups
  cancel-in-progress: false

jobs:
  restore:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      SHOPIFY_SHOP: ${{ secrets.SHOPIFY_SHOP }}
      SHOPIFY_STORE_DOMAIN: ${{ secrets.SHOPIFY_SHOP }}
      SHOPIFY_ACCESS_TOKEN: ${{ secrets.SHOPIFY_ACCESS_TOKEN }}
      SHOPIFY_BLOG_ID: ${{ secrets.SHOPIFY_BLOG_ID }}
      SHOPIFY_API_VERSION: ${{ secrets.SHOPIFY_API_VERSION }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install requests python-dotenv beautifulsoup4 PyYAML

      - name: Restore from backups
        working-directory: Agent - Pinterest -Shopify Blog Autopilot - End-to-End Content Factory/pipeline_v2
        shell: bash
        timeout-minutes: 30
        run: |
          set -euo pipefail
          echo "Starting restore from backups..."
          echo "Inputs: limit=${{ inputs.limit }}, ids=${{ inputs.ids }}, force=${{ inputs.force }}, keep_failed=${{ inputs.keep_failed }}, dry_run=${{ inputs.dry_run }}"
          args=()
          if [ -n "${{ inputs.ids }}" ]; then
            args+=(--ids "${{ inputs.ids }}")
          fi
          if [ -n "${{ inputs.limit }}" ]; then
            args+=(--limit "${{ inputs.limit }}")
          fi
          if [ "${{ inputs.force }}" = "true" ]; then
            args+=(--force)
          fi
          if [ "${{ inputs.keep_failed }}" = "true" ]; then
            args+=(--keep-failed)
          fi
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            args+=(--dry-run)
          fi
          echo "Running: python restore_from_backups.py ${args[*]:-}"
          python restore_from_backups.py "${args[@]:-}" 2>&1 | tee restore_output.txt
          echo "Restore completed with exit code: $?"

      - name: Upload restore artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: restore-from-backups
          path: |
            Agent - Pinterest -Shopify Blog Autopilot - End-to-End Content Factory/pipeline_v2/restore_from_backups_log.json
            Agent - Pinterest -Shopify Blog Autopilot - End-to-End Content Factory/pipeline_v2/restore_output.txt
          if-no-files-found: ignore
          retention-days: 7

      - name: Restore summary
        if: always()
        run: |
          echo "## Restore From Backups" >> $GITHUB_STEP_SUMMARY
          echo "- Timestamp: $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "- Limit: ${{ inputs.limit }}" >> $GITHUB_STEP_SUMMARY
          echo "- IDs: ${{ inputs.ids || 'all' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Force: ${{ inputs.force }}" >> $GITHUB_STEP_SUMMARY
          echo "- Dry Run: ${{ inputs.dry_run }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f "Agent - Pinterest -Shopify Blog Autopilot - End-to-End Content Factory/pipeline_v2/restore_output.txt" ]; then
            echo "### Output (last 100 lines)" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -n 100 "Agent - Pinterest -Shopify Blog Autopilot - End-to-End Content Factory/pipeline_v2/restore_output.txt" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
