name: Meta-Agent Autonomous Worker
# =====================================================
# META-AGENT - Tá»± Ä‘á»™ng 100%
# - Tá»± cháº¡y theo schedule
# - Tá»± táº¡o agent con
# - Tá»± commit, tá»± push
# - Tá»± check & tá»± fix lá»—i
# KhÃ´ng cáº§n VS Code, khÃ´ng cáº§n approve thá»§ cÃ´ng
# =====================================================

on:
  schedule:
    # Cháº¡y má»—i 6 giá»
    - cron: "0 */6 * * *"
  workflow_dispatch:
    inputs:
      task:
        description: "Task to execute (leave empty for default tasks)"
        required: false
        type: string
      dry_run:
        description: "Dry run - no commit/push"
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write
  issues: write

env:
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
  DRY_RUN: ${{ github.event.inputs.dry_run }}

jobs:
  meta-agent:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: ".github/agent/requirements.txt"

      - name: Install Python dependencies
        run: |
          pip install -r .github/agent/requirements.txt

      - name: Run Meta-Agent
        id: agent
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          TASK_INPUT: ${{ github.event.inputs.task }}
          DRY_RUN: ${{ github.event.inputs.dry_run }}
        run: |
          cd .github/agent
          python main.py

      - name: Run safety checks
        id: checks
        run: |
          echo "Running safety checks..."

          # Check only *this run's* changes (working tree + staged), not previous commits
          CHANGED=$(git diff --name-only; git diff --cached --name-only) || true
          FORBIDDEN=".github/workflows apps/ package.json package-lock.json .env vertex-sa.json"
          for path in $FORBIDDEN; do
            if echo "$CHANGED" | grep -q "^$path"; then
              echo "ERROR: Forbidden path modified by this run: $path"
              exit 1
            fi
          done

          echo "All safety checks passed!"

      - name: Commit and push changes
        if: ${{ github.event.inputs.dry_run != 'true' }}
        run: |
          git config user.name "Meta-Agent"
          git config user.email "meta-agent@autonomous.bot"

          # Only add allowed paths
          git add artifacts/ blogs/ REPORT.md logs/ 2>/dev/null || true
          git add .github/agent/agents/generated/ 2>/dev/null || true
          git add .github/agent/reports/ 2>/dev/null || true

          # Check if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          # Commit with timestamp
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")
          git commit -m "ğŸ¤– Meta-Agent: $TIMESTAMP"

          # Push
          git push origin HEAD

          echo "Changes committed and pushed successfully!"

      - name: Create run summary
        if: always()
        run: |
          echo "## Meta-Agent Run Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp**: $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Dry Run**: ${{ github.event.inputs.dry_run || 'false' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Generated Agents" >> $GITHUB_STEP_SUMMARY
          ls -la .github/agent/agents/generated/*.py 2>/dev/null || echo "No generated agents yet" >> $GITHUB_STEP_SUMMARY

      - name: Save run log
        if: always()
        run: |
          mkdir -p logs
          TIMESTAMP=$(date -u +"%Y-%m-%d_%H-%M-%S")
          LOG_FILE="logs/agent-run-$TIMESTAMP.log"

          echo "# Autonomous Agent Run Log" > "$LOG_FILE"
          echo "Timestamp: $(date -u)" >> "$LOG_FILE"
          echo "Status: ${{ job.status }}" >> "$LOG_FILE"
          echo "Trigger: ${{ github.event_name }}" >> "$LOG_FILE"
          echo "Task: ${{ github.event.inputs.task || 'scheduled' }}" >> "$LOG_FILE"
          echo "" >> "$LOG_FILE"
          echo "## Changes" >> "$LOG_FILE"
          git diff --stat HEAD~1 2>/dev/null >> "$LOG_FILE" || echo "No previous commit" >> "$LOG_FILE"

          # Commit log if not dry run
          if [ "${{ github.event.inputs.dry_run }}" != "true" ]; then
            git add logs/
            git commit -m "ğŸ“ Agent run log: $TIMESTAMP" || true
            git push origin HEAD || true
          fi
