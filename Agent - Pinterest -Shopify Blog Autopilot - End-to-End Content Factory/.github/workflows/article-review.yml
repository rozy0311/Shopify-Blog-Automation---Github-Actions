# Article Pre-Publish Review - META-PROMPT compliance then cleanup + set featured + publish
# See PROMPT file: 11-section, 1800-2500 words, 5+ sources (Name — Description), 2+ expert quotes, 3+ stats, no generic

name: Article Pre-Publish Review

on:
    workflow_dispatch:
        inputs:
            article_id:
                description: "Shopify article ID to review (then cleanup + publish if pass)"
                required: true
                type: string
            publish_anyway:
                description: "Nếu bật: vẫn cleanup + set featured + publish dù review không pass (fix tối thiểu)"
                required: false
                default: false
                type: boolean

permissions:
    contents: read

jobs:
    review-and-publish:
        runs-on: ubuntu-latest
        env:
            SHOPIFY_SHOP: ${{ secrets.SHOPIFY_SHOP }}
            SHOPIFY_STORE_DOMAIN: ${{ secrets.SHOPIFY_SHOP }}
            SHOPIFY_ACCESS_TOKEN: ${{ secrets.SHOPIFY_ACCESS_TOKEN }}
            SHOPIFY_BLOG_ID: ${{ secrets.SHOPIFY_BLOG_ID }}
            SHOPIFY_API_VERSION: ${{ secrets.SHOPIFY_API_VERSION }}
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"

            - name: Install dependencies
              run: python -m pip install --upgrade pip && pip install requests beautifulsoup4 python-dotenv PyYAML google-auth pillow

            # Prefer repo root (pipeline_v2 at root). Output dir + pipeline_dir for stable paths.
            - name: Set agent dir
              id: agent_dir
              run: |
                  SUB="Agent - Pinterest -Shopify Blog Autopilot - End-to-End Content Factory"
                  if [ -f "pipeline_v2/publish_now_graphql.py" ]; then
                    echo "dir=." >> $GITHUB_OUTPUT
                    echo "pipeline_dir=pipeline_v2" >> $GITHUB_OUTPUT
                    echo "Using agent dir: . (repo root), pipeline_dir: pipeline_v2"
                  elif [ -f "$SUB/pipeline_v2/publish_now_graphql.py" ]; then
                    echo "dir=$SUB" >> $GITHUB_OUTPUT
                    echo "pipeline_dir=$SUB/pipeline_v2" >> $GITHUB_OUTPUT
                    echo "Using agent dir: $SUB"
                  else
                    echo "Neither ./pipeline_v2 nor $SUB/pipeline_v2 contains publish_now_graphql.py"
                    ls -la pipeline_v2 2>/dev/null || true
                    ls -la "$SUB/pipeline_v2" 2>/dev/null || true
                    exit 1
                  fi

            - name: Run pre-publish review (initial)
              id: review_initial
              run: |
                  set +e
                  python "${{ steps.agent_dir.outputs.dir }}/scripts/pre_publish_review.py" "${{ inputs.article_id }}" | tee review-output.txt
                  echo "status=$?" >> $GITHUB_OUTPUT
              continue-on-error: true

            - name: Auto-fix on review failure
              if: steps.review_initial.outputs.status != '0'
              working-directory: ${{ steps.agent_dir.outputs.pipeline_dir }}
              run: python ai_orchestrator.py fix-ids "${{ inputs.article_id }}"

            - name: Run pre-publish review (after fix)
              if: steps.review_initial.outputs.status != '0'
              id: review_after_fix
              run: |
                  set +e
                  python "${{ steps.agent_dir.outputs.dir }}/scripts/pre_publish_review.py" "${{ inputs.article_id }}" | tee review-output-after-fix.txt
                  echo "status=$?" >> $GITHUB_OUTPUT
              continue-on-error: true

            - name: Force rebuild on review failure
              if: steps.review_after_fix.outputs.status != '0'
              working-directory: ${{ steps.agent_dir.outputs.pipeline_dir }}
              run: python ai_orchestrator.py force-rebuild-ids "${{ inputs.article_id }}"

            - name: Fix images (standalone)
              if: steps.review_after_fix.outputs.status != '0'
              working-directory: ${{ steps.agent_dir.outputs.pipeline_dir }}
              run: python fix_images_properly.py --article-id "${{ inputs.article_id }}" || true

            - name: Run pre-publish review (after rebuild)
              if: steps.review_after_fix.outputs.status != '0'
              id: review_after_rebuild
              run: |
                  set +e
                  python "${{ steps.agent_dir.outputs.dir }}/scripts/pre_publish_review.py" "${{ inputs.article_id }}" | tee review-output-after-rebuild.txt
                  echo "status=$?" >> $GITHUB_OUTPUT
              continue-on-error: true

            # Run from agent root so path works for both repo layouts (root=Content Factory or subfolder).
            - name: Publish to Shopify (cleanup + set featured + publish)
              if: steps.review_initial.outputs.status == '0' || steps.review_after_fix.outputs.status == '0' || steps.review_after_rebuild.outputs.status == '0' || github.event.inputs.publish_anyway == 'true'
              run: |
                  BASE="${{ steps.agent_dir.outputs.dir }}"
                  cd "$BASE"
                  python pipeline_v2/cleanup_before_publish.py "${{ inputs.article_id }}"
                  python pipeline_v2/set_featured_image_if_missing.py "${{ inputs.article_id }}"
                  python pipeline_v2/publish_now_graphql.py "${{ inputs.article_id }}"

            - name: Fail if review never passed (and not publish_anyway)
              if: (steps.review_initial.outputs.status != '0' && steps.review_after_fix.outputs.status != '0' && steps.review_after_rebuild.outputs.status != '0') && github.event.inputs.publish_anyway != 'true'
              run: |
                  echo "Pre-publish review failed (meta-prompt not met). Not publishing. Enable 'publish_anyway' to still cleanup + set featured + publish."
                  exit 1

            - name: Upload review output
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: pre-publish-review-${{ inputs.article_id }}
                  path: |
                      review-output.txt
                      review-output-after-fix.txt
                      review-output-after-rebuild.txt
                  if-no-files-found: ignore

            - name: Summary
              if: always()
              run: |
                  echo "## Article Pre-Publish Review (Meta-Prompt)" >> $GITHUB_STEP_SUMMARY
                  echo "- Article ID: ${{ inputs.article_id }}" >> $GITHUB_STEP_SUMMARY
                  echo "- Publish anyway: ${{ github.event.inputs.publish_anyway }}" >> $GITHUB_STEP_SUMMARY
                  echo "- Initial: ${{ steps.review_initial.outputs.status == '0' && 'PASS' || 'FAIL' }}" >> $GITHUB_STEP_SUMMARY
                  echo "- After fix: ${{ steps.review_after_fix.outputs.status == '0' && 'PASS' || 'N/A or FAIL' }}" >> $GITHUB_STEP_SUMMARY
                  echo "- After rebuild: ${{ steps.review_after_rebuild.outputs.status == '0' && 'PASS' || 'N/A or FAIL' }}" >> $GITHUB_STEP_SUMMARY
                  echo "- Published: ${{ steps.review_initial.outputs.status == '0' || steps.review_after_fix.outputs.status == '0' || steps.review_after_rebuild.outputs.status == '0' || github.event.inputs.publish_anyway == 'true' }}" >> $GITHUB_STEP_SUMMARY
