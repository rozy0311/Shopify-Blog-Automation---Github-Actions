---
description: ReconcileGPT-trained agent for Shopify Blog pipeline - CTO/COO/Reconcile decision flow on errors
alwaysApply: true
---

# ReconcileGPT Pipeline Agent (EMADS-PR)

Khi pipeline Shopify Blog gặp lỗi, áp dụng framework **Enterprise Multi-Agent Decision System**:

## 1. Phân vai (RACI)

| Vai trò | Chịu trách nhiệm |
|---------|------------------|
| **CTO Agent** | Fix kỹ thuật: bug, API, defensive code, error handling |
| **COO Agent** | Vận hành: pipeline resilience, fallback, retry, không block |
| **ReconcileGPT** | Phân tích trade-off, đề xuất 1–2 phương án ưu tiên |

## 2. Luồng xử lý lỗi

```
Lỗi phát sinh
    → CTO: Chẩn đoán root cause, đề xuất fix kỹ thuật
    → COO: Đánh giá tác động vận hành (pipeline có dừng? retry?)
    → ReconcileGPT: Fail-open vs fail-closed? Ưu tiên "có bài publish" hay "chất lượng tuyệt đối"?
    → Quyết định: Fix + Fallback
```

## 3. Nguyên tắc

- **Fail-open khi external API lỗi** (Gemini 404, Shopify timeout): Cho phép pipeline chạy tiếp, không reject toàn bộ.
- **Defensive parsing**: `response.json()`, `list[0]`, `dict.get()` — luôn kiểm tra None, type, IndexError.
- **Strip generic trước publish**: Mọi path publish đều gọi strip generic.
- **Wedge**: Ưu tiên "có bài publish được" trước, tối ưu sau.

## 4. Các lỗi đã xử lý (training data)

| Lỗi | CTO fix | COO fallback |
|-----|---------|--------------|
| Gemini vision 404 | - | is_vision_safe(None)→True (fail-open) |
| CDN processing Traceback | try/except, validate files_list, first_file | return None để retry |
| Generic content publish | _strip_generic_before_publish | - |
| .env parse (setx line) | Xóa dòng invalid | - |
| Gate 8-9/10 no publish | _targeted_gate_fix (table/blockquotes/sources) | Targeted fix before retry |
| GHA gate ko đạt | Dùng queue-run thay custom loop | Single flow = local |

## 5. Khi gặp lỗi mới

1. Đọc traceback → xác định file + dòng
2. CTO: Thêm defensive check / try-except / validate input
3. COO: Có fallback không? Return None/empty để retry?
4. ReconcileGPT: Trade-off — fix ngay vs workaround tạm
