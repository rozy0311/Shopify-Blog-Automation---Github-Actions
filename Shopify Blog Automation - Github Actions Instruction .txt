PROBLEM REFRAME
Thiáº¿t káº¿ vÃ  triá»ƒn khai má»™t pipeline khÃ´ng dÃ¹ng n8n Ä‘á»ƒ Ä‘á»c hÃ ng Ä‘á»£i bÃ i viáº¿t tá»« Google Sheets, sinh ná»™i dung blog theo â€œAIO + humanized, NO YEARSâ€, Ä‘Äƒng tháº³ng lÃªn Shopify blog handle agritourism vá»›i author â€œThe Rikeâ€, vÃ  cáº­p nháº­t URL bÃ i viáº¿t trá»Ÿ láº¡i Google Sheets. Pipeline pháº£i cÃ³ retry, quan sÃ¡t, batch 30 itemláº§n, lá»‹ch cháº¡y 3 láº§nngÃ y, kÃ¨m guardrails Level-6 máº·c Ä‘á»‹nh khÃ´ng publish (kill-switch WF_ENABLED=false), cÃ³ manual trigger Ä‘á»ƒ dry-run, pre-checks vÃ  early-exit cho thao tÃ¡c rá»§i ro.

CONSTRAINTS & RISKS

Thiáº¿u Google Sheet ID, quyá»n truy cáº­p (service account hoáº·c OAuth), Shopify Admin API token cÃ³ scope write_content.

Google Sheets cáº§n tab Sheet1 (Aurl_blog_crawl, Burl_blog_shopify) vÃ  tab CONFIG (Akey, Bvalue) chá»©a tá»‘i thiá»ƒu LLM_CONTROL_PROMPT (â‰¥50 kÃ½ tá»±, cÃ³ {{URL_BLOG}}), BLOG_HANDLE (máº·c Ä‘á»‹nh agritourism), AUTHOR (máº·c Ä‘á»‹nh The Rike).

Rá»§i ro model tráº£ non-JSON; ná»™i dung cÃ³ nÄƒm; Shopify blog handle khÃ´ng tá»“n táº¡i; háº¿t quota API; lá»—i máº¡ng.

ChÃ­nh sÃ¡ch khÃ´ng tá»± publish khi chÆ°a báº­t WF_ENABLED; all writes pháº£i qua pre-check.

Äá»“ng bá»™ giá» lá»‹ch GitHub Actions á»Ÿ UTC; cáº§n map Ä‘Ãºng vá»›i AmericaChicago.

TARGET STATE (DEFINITION OF DONE)

Cron cháº¡y 3 láº§nngÃ y á»Ÿ UTC tÆ°Æ¡ng á»©ng 0705, 1305, 2005 AmericaChicago.

Má»—i láº§n cháº¡y láº¥y tá»‘i Ä‘a 30 dÃ²ng pending (A cÃ³ URL, B trá»‘ng), xá»­ lÃ½ tuáº§n tá»±, lá»—i item khÃ´ng cháº·n batch.

BÃ i há»£p lá»‡ Ä‘Æ°á»£c publish vÃ o blog handle agritourism, author â€œThe Rikeâ€; náº¿u cÃ³ áº£nh thÃ¬ gÃ¡n áº£nh 1 lÃ m featured.

Sau publish, cá»™t url_blog_shopify Ä‘iá»n URL canonical Ä‘Ãºng Ä‘á»‹nh dáº¡ng https{SHOP}.myshopify.comblogs{handle}{article.handle}.

Log tá»•ng káº¿t run gá»“m AttemptedProcessedFailed lÆ°u artifact vÃ  in console.

Guardrails cÃ³ hiá»‡u lá»±c WF_ENABLED=false ngÄƒn POST Shopify; manual dispatch há»— trá»£ dry-run.

SOLUTION BLUEPRINT

DataInput Google Sheets API Ä‘á»c CONFIG!AB vÃ  Sheet1!AB.

LLMLogic OpenAI Chat Completions vá»›i response_format=json_object; há»‡ thá»‘ng prompt = LLM_CONTROL_PROMPT + rule NO YEARS; validate JSON + regex b(1920)d{2}b; tá»‘i Ä‘a 4 áº£nh URL cÃ´ng khai.

OrchestrationScheduling GitHub Actions (cron + workflow_dispatch); batcher 30; per-item trycatch; retry backoff 2s5s10s cho OpenAIShopifySheets.

External APIs

Google Sheets v4 (readupdate by key).

Shopify Admin REST 2023-10 GET adminapi2023-10blogs.json chá»n blog theo handle; POST adminapi2023-10blogs{blog_id}articles.json.

OpenAI Chat Completions.

OutputPersistenceLogging stdout logs; JSON summary artifact; optional GitHub Issue comment cho batch summary.

Human-in-the-loop Level-6 hybrid

WF_ENABLED repo variable máº·c Ä‘á»‹nh false.

Manual workflow_dispatch Ä‘á»ƒ dry-run.

Optional mÃ´i trÆ°á»ng â€œproductionâ€ GitHub Actions yÃªu cáº§u approval trÆ°á»›c khi run (environment protection).

TOOL DECISION

GitHub Actions + NodeTypeScript CLI Ä‘Æ¡n giáº£n, auditable, dá»… CICD, cron UTC chuáº©n; khÃ´ng cáº§n háº¡ táº§ng má»›i.

Google Sheets API + Shopify REST + OpenAI SDKREST á»•n Ä‘á»‹nh, quyá»n rÃµ rÃ ng.

Agent BuilderAgentKit (tÃ¹y chá»n) cÃ³ thá»ƒ dÃ¹ng sau Ä‘á»ƒ thÃªm UI chat, evals, guardrails; nhÆ°ng bÆ°á»›c Ä‘áº§u Æ°u tiÃªn GHA Ä‘á»ƒ Ä‘áº¡t DONE nhanh, cÃ³ lá»‹ch vÃ  logs chuáº©n.

EXECUTION PLAN (DO THIS â†’ THEN THIS)
A) Repo layout

shopify-blog-automation
  â”œâ”€ src
  â”‚   â”œâ”€ index.ts              # entry
  â”‚   â”œâ”€ sheets.ts             # readQueue, readConfig, updateUrl
  â”‚   â”œâ”€ llm.ts                # callOpenAI, validateNoYears, parseJson
  â”‚   â”œâ”€ shopify.ts            # getBlogByHandle, createArticle
  â”‚   â”œâ”€ batch.ts              # batch runner, retries, summary
  â”‚   â””â”€ util.ts               # logger, backoff, env, prechecks
  â”œâ”€ package.json
  â”œâ”€ tsconfig.json
  â”œâ”€ .githubworkflowspublish.yml
  â”œâ”€ .env.sample
  â””â”€ README.md


B) Env & secrets

SHEETS_ID=...
SHEETS_RANGE=Sheet1!AB
CONFIG_RANGE=CONFIG!AB
SHOPIFY_SHOP=therikeus
SHOPIFY_TOKEN=   # GitHub Actions secret
BLOG_HANDLE=agritourism
AUTHOR=The Rike
OPENAI_API_KEY=  # GitHub Actions secret
OPENAI_MODEL=gpt-4o-mini
WF_ENABLED=false    # repo variable default


C) Key code (rÃºt gá»n, implement-ready)

llm.ts

export async function callOpenAI(systemPrompt string, model string) {
  const res = await fetch(httpsapi.openai.comv1chatcompletions, {
    method POST,
    headers { Authorization `Bearer ${process.env.OPENAI_API_KEY}`, Content-Type applicationjson },
    body JSON.stringify({
      model, temperature 0.3, max_tokens 2200,
      response_format { type json_object },
      messages [
        { role system, content systemPrompt },
        { role user, content Return only a single minified JSON object. No markdown, no code fences, no commentary. }
      ]
    })
  });
  const j = await res.json();
  const text = j.choices.[0].message.content  ;
  return parseJsonRelaxed(text);
}

export function parseJsonRelaxed(text string) {
  const strip = (sstring)=s.replace(^```[sS]n,'').replace(```$,'');
  let t = strip(text).replace([â€œâ€]g,'').replace([â€˜â€™]g,');
  try { return JSON.parse(t); } catch {}
  const i=t.indexOf({), k=t.lastIndexOf(});
  if(i=0 && ki) return JSON.parse(t.slice(i,k+1));
  throw new Error(LLM returned non-JSON);
}

export function validateNoYears(payload{titlestring; seo_titlestring; meta_descstring; htmlstring}) {
  const rx = b(1920)d{2}b;
  const blob = `${payload.title} ${payload.seo_title} ${payload.meta_desc} ${payload.html}`;
  if (rx.test(blob)) throw new Error(NO YEARS violation);
}


sheets.ts (dÃ¹ng Google Sheets API v4)

import { google } from googleapis;
const auth = new google.auth.GoogleAuth({ scopes[httpswww.googleapis.comauthspreadsheets] });

export async function readConfig() {
  const sheets = google.sheets({ version v4, auth await auth.getClient() });
  const range = process.env.CONFIG_RANGE  CONFIG!AB;
  const { data } = await sheets.spreadsheets.values.get({ spreadsheetId process.env.SHEETS_ID!, range });
  const rows = data.values  [];
  const kv Recordstring,string = {};
  for (const [k,v] of rows.slice(1)) if (k) kv[k] = (v  );
  kv.BLOG_HANDLE = kv.BLOG_HANDLE  process.env.BLOG_HANDLE  agritourism;
  kv.AUTHOR = kv.AUTHOR  process.env.AUTHOR  The Rike;
  return kv;
}

export async function readQueue(limit=30) {
  const sheets = google.sheets({ versionv4, auth await auth.getClient() });
  const range = process.env.SHEETS_RANGE  Sheet1!AB;
  const { data } = await sheets.spreadsheets.values.get({ spreadsheetId process.env.SHEETS_ID!, range });
  const rows = data.values  [];
  const pending = rows.slice(1)
    .map(r = ({ url_blog_crawl (r[0]).trim(), url_blog_shopify (r[1]).trim() }))
    .filter(x = x.url_blog_crawl && !x.url_blog_shopify)
    .slice(0, limit);
  return pending;
}

export async function updateBack(url_blog_crawlstring, published_urlstring){
  const sheets = google.sheets({ versionv4, auth await auth.getClient() });
  const range = process.env.SHEETS_RANGE  Sheet1!AB;
  const { data } = await sheets.spreadsheets.values.get({ spreadsheetId process.env.SHEETS_ID!, range });
  const rows = data.values  [];
   find row index by crawl url
  const idx = rows.findIndex(r = (r.[0]).trim() === url_blog_crawl);
  if (idx  0) throw new Error(Row not found for backfill);
  const targetRange = `Sheet1!B${idx+1}B${idx+1}`;
  await sheets.spreadsheets.values.update({
    spreadsheetId process.env.SHEETS_ID!, range targetRange, valueInputOption RAW,
    requestBody { values [[published_url]] }
  });
}


shopify.ts

export async function getBlogByHandle(handlestring){
  const res = await fetch(`https${process.env.SHOPIFY_SHOP}.myshopify.comadminapi2023-10blogs.json`,{
    headers{ X-Shopify-Access-Token process.env.SHOPIFY_TOKEN!, Content-Typeapplicationjson }
  });
  const j = await res.json();
  const blog = (j.blogs[]).find((bany)= (b.handle)===handle);
  if(!blog) throw new Error(Blog handle not found +handle);
  return blog;
}

export async function createArticle(blogIdstring, payloadany){
  const res = await fetch(`https${process.env.SHOPIFY_SHOP}.myshopify.comadminapi2023-10blogs${blogId}articles.json`,{
    methodPOST,
    headers{ X-Shopify-Access-Token process.env.SHOPIFY_TOKEN!, Content-Typeapplicationjson },
    body JSON.stringify({ article payload })
  });
  if(!res.ok){ throw new Error(`Shopify POST failed ${res.status}`); }
  return res.json();
}


batch.ts

const wait = (msnumber)= new Promise(r=setTimeout(r,ms));
export async function withRetryT(fn()=PromiseT) {
  const waits=[2000,5000,10000];
  for (let i=0;iwaits.length;i++){
    try { return await fn(); } catch(e){ if(i===waits.length-1) throw e; await wait(waits[i]); }
  }
   unreachable
}


index.ts

import { readConfig, readQueue, updateBack } from .sheets;
import { callOpenAI, validateNoYears } from .llm;
import { getBlogByHandle, createArticle } from .shopify;
import { withRetry } from .batch;

(async ()={
  const cfg = await readConfig();
  const queue = await readQueue(30);
  const summary = { attempted queue.length, processed0, failed0, errors[] as any[] };

  if (!queue.length) { console.log(No pending items); process.exit(0); }

  const blogHandle = cfg.BLOG_HANDLE  agritourism;
  const author = cfg.AUTHOR  The Rike;
  const wfEnabled = (process.env.WF_ENABLEDfalse) === true;
  const blog = wfEnabled  await withRetry(()=getBlogByHandle(blogHandle))  null;

  for (const row of queue){
    try{
      const ctrl = (cfg.LLM_CONTROL_PROMPT).toString();
      if (ctrl.length  50  !ctrl.includes({{URL_BLOG}})) throw new Error(Invalid LLM_CONTROL_PROMPT);
      const sys = ctrl.replace({{URL_BLOG}}g, row.url_blog_crawl)
        + nnRules Return JSON only {title, seo_title, meta_desc, html, images[{src,alt}]}; HTML Shopify-safe; NO YEARS; up to 4 images.;

      const data = await withRetry(()=callOpenAI(sys, process.env.OPENAI_MODELgpt-4o-mini));
      validateNoYears(data);

      if (!wfEnabled) { console.log(`[DRY-RUN] Would publish ${row.url_blog_crawl}`); summary.processed++; continue; }

      const image = Array.isArray(data.images)&&data.images[0].src  { src data.images[0].src }  null;
      const created = await withRetry(()=createArticle(blog.id, {
        title data.title, author, body_html data.html, tags [], image
      }));
      const handle = created.article.handle;
      const url = `https${process.env.SHOPIFY_SHOP}.myshopify.comblogs${blogHandle}${handle}`;
      await withRetry(()=updateBack(row.url_blog_crawl, url));
      console.log(`Published ${url}`);
      summary.processed++;
    }catch(eany){
      summary.failed++; summary.errors.push({ url row.url_blog_crawl, error String(e.messagee) });
      console.error(`Failed for ${row.url_blog_crawl}`, e.messagee);
      continue;
    }
  }
  console.log(SUMMARY, JSON.stringify(summary));
   write summary artifact if desired
})();


D) GitHub Actions workflow .githubworkflowspublish.yml

name Shopify Blog Automation

on
  workflow_dispatch {}
  schedule
    # AmericaChicago 0705, 1305, 2005 â‰ˆ UTC 1305, 1905, 0205 (CST, UTC-6)
    - cron '5 13,19,2   '

jobs
  run
    runs-on ubuntu-latest
    environment production   # optional require approval
    steps
      - uses actionscheckout@v4
      - uses actionssetup-node@v4
        with { node-version '20' }
      - run npm ci
      - name Set env
        run 
          echo SHEETS_ID=${{ vars.SHEETS_ID }}  $GITHUB_ENV
          echo SHEETS_RANGE=${{ vars.SHEETS_RANGE }}  $GITHUB_ENV
          echo CONFIG_RANGE=${{ vars.CONFIG_RANGE }}  $GITHUB_ENV
          echo SHOPIFY_SHOP=${{ vars.SHOPIFY_SHOP }}  $GITHUB_ENV
          echo BLOG_HANDLE=${{ vars.BLOG_HANDLE }}  $GITHUB_ENV
          echo AUTHOR=${{ vars.AUTHOR }}  $GITHUB_ENV
          echo WF_ENABLED=${{ vars.WF_ENABLED }}  $GITHUB_ENV
          echo OPENAI_MODEL=${{ vars.OPENAI_MODEL }}  $GITHUB_ENV
        shell bash
      - name Inject secrets
        run 
          echo SHOPIFY_TOKEN=${{ secrets.SHOPIFY_TOKEN }}  $GITHUB_ENV
          echo OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}  $GITHUB_ENV
      - run npm run build --if-present
      - run node distindex.js


HARD FAIL CRITERIA

Báº¥t ká»³ láº§n cháº¡y cron nÃ o cÃ³ â‰¥1 item há»£p lá»‡ nhÆ°ng processed=0 vÃ  khÃ´ng cÃ³ lÃ½ do guardrails, trong 2 chu ká»³ liÃªn tiáº¿p.

Tá»‰ lá»‡ lá»—i  50% trong 3 láº§n cháº¡y liÃªn tiáº¿p.

Ná»™i dung Ä‘Æ°á»£c publish chá»©a nÄƒm theo regex b(1920)d{2}b.

KhÃ´ng táº¡okhÃ´ng cáº­p nháº­t URL trá»Ÿ láº¡i Google Sheet cho item Ä‘Ã£ publish.

Shopify khÃ´ng cÃ³ bÃ i má»›i dÆ°á»›i blog handle má»¥c tiÃªu khi WF_ENABLED=true.

NEXT REQUIRED INPUT
Cung cáº¥p Google Sheet ID (SHEETS_ID) mÃ  báº¡n muá»‘n dÃ¹ng cho hÃ ng Ä‘á»£i vÃ  cáº¥u hÃ¬nh (vÃ  xÃ¡c nháº­n Ä‘Ã£ share cho service account náº¿u báº¡n dÃ¹ng Google Service Account).

________________________________________

PROBLEM REFRAME
Báº¡n muá»‘n bá» n8n vÃ  thay báº±ng má»™t há»‡ thá»‘ng tá»± Ä‘á»™ng hoÃ n toÃ n, Ä‘iá»u khiá»ƒn Ä‘Æ°á»£c tá»« GitHub Actions vÃ /hoáº·c VS Code: Ä‘á»c queue tá»« Google Sheets, dÃ¹ng LLM táº¡o bÃ i blog â€œAIO + humanized, NO YEARSâ€, Ä‘Äƒng tháº³ng lÃªn Shopify (blog handle agritourism, author â€œThe Rikeâ€), vÃ  ghi URL publish vá» láº¡i Google Sheets. Há»‡ thá»‘ng pháº£i cÃ³ batch 30, retry/backoff, quan sÃ¡t, cháº¡y 3 láº§n/ngÃ y, Dry-run máº·c Ä‘á»‹nh vá»›i kill-switch WF_ENABLED=false, chá»‰ publish khi báº­t.

CONSTRAINTS & RISKS

Thiáº¿u Ä‘áº§u vÃ o báº¯t buá»™c: SHEETS_ID, quyá»n Google Sheets (service account hoáº·c OAuth), SHOPIFY_TOKEN cÃ³ scope write_content, OPENAI_API_KEY.

Cron GitHub Actions cháº¡y theo UTC, cáº§n map chÃ­nh xÃ¡c America/Chicago.

Giá»›i háº¡n API (LLM/Shopify/Sheets), lá»—i máº¡ng, JSON khÃ´ng chuáº©n tá»« LLM, ná»™i dung chá»©a nÄƒm, blog handle khÃ´ng tá»“n táº¡i.

Báº£o máº­t secrets; khÃ´ng commit khÃ³a.

Quy trÃ¬nh phÃª duyá»‡t Level-6: máº·c Ä‘á»‹nh khÃ´ng publish (WF_ENABLED=false); cáº§n manual hoáº·c environment approval.

TARGET STATE (DEFINITION OF DONE)

Repo cÃ³ workflow GitHub Actions cháº¡y 13:05, 19:05, 02:05 UTC tÆ°Æ¡ng á»©ng 07:05, 13:05, 20:05 America/Chicago.

Má»—i run xá»­ lÃ½ tá»‘i Ä‘a 30 dÃ²ng pending, item-level retry 2sâ†’5sâ†’10s, lá»—i 1 item khÃ´ng cháº·n batch.

Khi WF_ENABLED=true: bÃ i Ä‘Æ°á»£c táº¡o Ä‘Ãºng blog handle agritourism, author â€œThe Rikeâ€, image[0] lÃ m featured náº¿u cÃ³; URL canonical Ä‘Æ°á»£c ghi vÃ o cá»™t url_blog_shopify.

Log tá»•ng káº¿t Attempted/Processed/Failed xuáº¥t ra console vÃ  lÆ°u artifact.

Dry-run khi WF_ENABLED=false Ä‘i qua toÃ n pipeline trá»« POST Shopify/Update Sheets.

SOLUTION BLUEPRINT

Data/input: Google Sheets Sheet1!A:B (A:url_blog_crawl, B:url_blog_shopify); CONFIG!A:B (key|value) gá»“m LLM_CONTROL_PROMPT (â‰¥50 kÃ½ tá»±, cÃ³ {{URL_BLOG}}), BLOG_HANDLE, AUTHOR.

LLM/logic: OpenAI Chat Completions response_format=json_object; rule NO YEARS; parser JSON resilient; tá»‘i Ä‘a 4 áº£nh URL cÃ´ng khai.

Orchestration/scheduling: GitHub Actions (cron + workflow_dispatch). VS Code Task/DevContainer Ä‘á»ƒ cháº¡y cá»¥c bá»™ cÃ¹ng logic.

Integrations: Google Sheets API v4, Shopify Admin REST 2023-10, OpenAI.

Output/persistence/logging: update Google Sheets; console log + GitHub artifact JSON summary; tÃ¹y chá»n má»Ÿ PR comment/Issue comment.

Human-in-the-loop: kill-switch WF_ENABLED=false; environment protection â€œproductionâ€ yÃªu cáº§u approval trÆ°á»›c khi run; manual dispatch Ä‘á»ƒ dry-run.

TOOL DECISION

GitHub Actions + Node/TypeScript CLI: cÃ³ cron, secrets, logs, artifacts, approvals; khÃ´ng cáº§n háº¡ táº§ng má»›i; reproducible.

VS Code (Tasks + DevContainer): cháº¡y cá»¥c bá»™ y há»‡ sáº£n xuáº¥t; dá»… debug.

Google Sheets API + Shopify REST + OpenAI: chuáº©n, Ä‘Æ¡n giáº£n, Ã­t phá»¥ thuá»™c.

Agent Builder/Agent Kits: dÃ¹ng sau Ä‘á»ƒ thÃªm UI/guardrails nÃ¢ng cao; khÃ´ng báº¯t buá»™c Ä‘á»ƒ Ä‘áº¡t DONE nhanh.

EXECUTION PLAN (DO THIS â†’ THEN THIS)
A) Scaffold repo

mkdir shopify-blog-automation && cd $_
npm init -y && npm i typescript ts-node node-fetch@3 googleapis dotenv
npm i -D @types/node
npx tsc --init
mkdir -p src .github/workflows


B) Source code (Ä‘áº·t file)

src/llm.ts (OpenAI JSON-mode, parser, NO YEARS)

src/sheets.ts (readConfig, readQueue, updateBack via Google Sheets API v4)

src/shopify.ts (getBlogByHandle, createArticle)

src/batch.ts (withRetry 2s/5s/10s)

src/index.ts (precheck prompt, batch 30, dry-run gate, summary).
(Äoáº¡n mÃ£ máº«u Ä‘Ã£ gá»­i á»Ÿ cÃ¢u tráº£ lá»i trÆ°á»›c; copy nguyÃªn xi lÃ  cháº¡y.)
C) Workflow GitHub Actions .github/workflows/publish.yml

name: Shopify Blog Automation
on:
  workflow_dispatch: {}
  schedule:
    - cron: '5 13,19,2 * * *'   # 07:05, 13:05, 20:05 America/Chicago
jobs:
  run:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: '20' }
      - run: npm ci
      - name: Export vars
        run: |
          echo "SHEETS_ID=${{ vars.SHEETS_ID }}" >> $GITHUB_ENV
          echo "SHEETS_RANGE=${{ vars.SHEETS_RANGE }}" >> $GITHUB_ENV
          echo "CONFIG_RANGE=${{ vars.CONFIG_RANGE }}" >> $GITHUB_ENV
          echo "SHOPIFY_SHOP=${{ vars.SHOPIFY_SHOP }}" >> $GITHUB_ENV
          echo "BLOG_HANDLE=${{ vars.BLOG_HANDLE }}" >> $GITHUB_ENV
          echo "AUTHOR=${{ vars.AUTHOR }}" >> $GITHUB_ENV
          echo "WF_ENABLED=${{ vars.WF_ENABLED }}" >> $GITHUB_ENV
          echo "OPENAI_MODEL=${{ vars.OPENAI_MODEL }}" >> $GITHUB_ENV
      - name: Inject secrets
        run: |
          echo "SHOPIFY_TOKEN=${{ secrets.SHOPIFY_TOKEN }}" >> $GITHUB_ENV
          echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> $GITHUB_ENV
      - run: npx tsc
      - run: node dist/index.js


D) VS Code automation

.vscode/tasks.json

{
  "version": "2.0.0",
  "tasks": [
    { "label": "build", "type": "shell", "command": "npx tsc" },
    { "label": "run:dry", "type": "shell", "command": "WF_ENABLED=false node dist/index.js" },
    { "label": "run:publish", "type": "shell", "command": "WF_ENABLED=true node dist/index.js" }
  ]
}


Devcontainer (tÃ¹y chá»n) .devcontainer/devcontainer.json

{ "name":"shopify-blog-auto","image":"mcr.microsoft.com/devcontainers/javascript-node:20","postCreateCommand":"npm ci" }


E) Thiáº¿t láº­p secrets/vars báº±ng GitHub CLI

gh repo create yourorg/shopify-blog-automation --private --source=. --push
gh variable set SHEETS_ID --body "<google_sheet_id>"
gh variable set SHEETS_RANGE --body "Sheet1!A:B"
gh variable set CONFIG_RANGE --body "CONFIG!A:B"
gh variable set SHOPIFY_SHOP --body "therikeus"
gh variable set BLOG_HANDLE --body "agritourism"
gh variable set AUTHOR --body "The Rike"
gh variable set WF_ENABLED --body "false"
gh variable set OPENAI_MODEL --body "gpt-4o-mini"
gh secret set SHOPIFY_TOKEN --body "<shopify_admin_token>"
gh secret set OPENAI_API_KEY --body "<openai_key>"


F) Dry-run & activate

# Dry-run thá»§ cÃ´ng
gh workflow run "Shopify Blog Automation" --ref main
gh run watch

# Báº­t publish
gh variable set WF_ENABLED --body "true"
# Approve environment náº¿u báº­t protection, hoáº·c Ä‘á»ƒ cron tá»± cháº¡y theo lá»‹ch


G) Google Sheets setup

CONFIG tab (A:key, B:value): LLM_CONTROL_PROMPT cÃ³ {{URL_BLOG}} vÃ  cÃ¢u â€œReturn ONLY a single minified JSON object with keys {title, seo_title, meta_desc, html, images:[{src,alt}]}. No prose, no markdown.â€ á»Ÿ cuá»‘i; BLOG_HANDLE=agritourism, AUTHOR=The Rike.

Sheet1 tab: url_blog_crawl | url_blog_shopify.

HARD FAIL CRITERIA

Hai láº§n cron liÃªn tiáº¿p cÃ³ pending mÃ  processed=0 khi WF_ENABLED=true.

Tá»‰ lá»‡ failed > 50% trong 3 láº§n cháº¡y liÃªn tiáº¿p.

Báº¥t ká»³ bÃ i publish chá»©a regex \b(19|20)\d{2}\b.

KhÃ´ng tÃ¬m tháº¥y bÃ i trÃªn Shopify hoáº·c khÃ´ng ghi URL vá» Google Sheets cho item Ä‘Ã£ publish.

LLM tráº£ non-JSON quÃ¡ 3 láº§n liÃªn tiáº¿p cho cÃ¹ng má»™t item (sau retry).

NEXT REQUIRED INPUT
Báº¡n muá»‘n dÃ¹ng Google Service Account hay OAuth Ä‘á»ƒ truy cáº­p Google Sheets? (chá»n 1)


TÃ´i Ä‘Ã£ Ä‘Ã³ng gÃ³i full giáº£i phÃ¡p ngoÃ i n8n Ä‘á»ƒ báº¡n tá»± Ä‘á»™ng toÃ n bá»™ báº±ng GitHub Actions hoáº·c cháº¡y ngay trong VS Code.

ğŸ“¦ Repo sáºµn sÃ ng cháº¡y
"D:\active-projects\Auto Blog Shopify NEW Rosie\Shopify Blog Automation - Github Actions\shopify-blog-automation"

BÃªn trong Ä‘Ã£ cÃ³:

src/ mÃ£ nguá»“n TypeScript: sheets.ts, llm.ts, shopify.ts, batch.ts, index.ts

.github/workflows/publish.yml cháº¡y 3 láº§n/ngÃ y

.env.sample Ä‘á»ƒ cháº¡y cá»¥c bá»™ (Ä‘á»«ng commit secrets tháº­t)

.vscode/tasks.json Ä‘á»ƒ báº¥m cháº¡y nhanh trong VS Code

Guardrails L6: WF_ENABLED=false máº·c Ä‘á»‹nh, dry-run an toÃ n

CÃ¡ch dÃ¹ng nhanh gá»n

Giáº£i nÃ©n repo, má»Ÿ VS Code:

npm ci
cp .env.sample .env   # chá»‰ cho cháº¡y local
# Ä‘iá»n SHEETS_ID, SHOPIFY_SHOP, ...
npx tsc
npm run dry           # cháº¡y dry-run, KHÃ”NG publish


Äáº©y lÃªn GitHub vÃ  cáº¥u hÃ¬nh tá»± Ä‘á»™ng:

gh repo create yourorg/shopify-blog-automation --private --source=. --push
# Variables (Environment â†’ Variables)
SHEETS_ID=<GoogleSheetID>
SHEETS_RANGE=Sheet1!A:B
CONFIG_RANGE=CONFIG!A:B
SHOPIFY_SHOP=therikeus
BLOG_HANDLE=agritourism
AUTHOR=The Rike
WF_ENABLED=false
OPENAI_MODEL=gpt-4o-mini
# Secrets
SHOPIFY_TOKEN=<admin_api_token_with_write_content>
OPENAI_API_KEY=<openai_key>


Lá»‹ch cron trong workflow Ä‘Ã£ set: 13:05, 19:05, 02:05 UTC tÆ°Æ¡ng á»©ng 07:05, 13:05, 20:05 America/Chicago.

Google Sheet chuáº©n

Tab CONFIG (A:key, B:value), pháº£i cÃ³:

LLM_CONTROL_PROMPT (â‰¥ 50 kÃ½ tá»±, cÃ³ {{URL_BLOG}} vÃ  káº¿t thÃºc báº±ng:
Return ONLY a single minified JSON object with keys {title, seo_title, meta_desc, html, images:[{src,alt}]}. No prose, no markdown.)

BLOG_HANDLE=agritourism, AUTHOR=The Rike

Tab Sheet1: url_blog_crawl | url_blog_shopify

Tá»± Ä‘á»™ng toÃ n bá»™ mÃ  váº«n cÃ³ phanh

Khi WF_ENABLED=false: pipeline cháº¡y Ä‘á»§ má»i bÆ°á»›c trá»« Shopify POST vÃ  ghi Google Sheets. DÃ¹ng Ä‘á»ƒ kiá»ƒm tra.

Báº­t publish:

# trÃªn GitHub (Settings â†’ Variables)
WF_ENABLED=true


hoáº·c local:

WF_ENABLED=true npm start

TÃ³m táº¯t cÃ¢u há»i cá»§a báº¡n

â€œCÃ³ cáº§n cung cáº¥p .env cho báº¡n khÃ´ng?â€
KhÃ´ng. Giá»¯ secrets cho báº¡n. .env chá»‰ dÃ¹ng local. TrÃªn GitHub thÃ¬ dÃ¹ng Variables vÃ  Secrets nhÆ° á»Ÿ trÃªn.

Xong. Báº¡n cÃ³ repo cháº¡y tháº­t, cron tháº­t, retry 2s/5s/10s, batch 30, NO YEARS, backfill vá» Google Sheet, kill-switch L6. Náº¿u cÃ¡i gÃ¬ cÃ²n gÃ o thÃ©t, quÄƒng log á»Ÿ step â€œSUMMARY â€¦â€ cho tÃ´i, tÃ´i xá»­ tiáº¿p.

CÃ¡i file .zip tÃ´i Ä‘Æ°a cho báº¡n khÃ´ng tá»± Ä‘á»™ng viáº¿t blog hay gÃµ bÃ n phÃ­m thay ngÆ°á»i Ä‘Ã¢u. NÃ³ chá»©a toÃ n bá»™ mÃ£ nguá»“n, workflow, vÃ  cáº¥u hÃ¬nh Ä‘á»ƒ báº¡n cháº¡y hoáº·c tá»± Ä‘á»™ng hÃ³a báº±ng GitHub Actions hoáº·c VS Code Task.
Cá»¥ thá»ƒ:

Náº¿u báº¡n dÃ¹ng VS Code

Giáº£i nÃ©n thÆ° má»¥c shopify-blog-automation/.

Má»Ÿ nÃ³ báº±ng VS Code.

Cháº¡y:

npm ci
npx tsc
cp .env.sample .env


Sau Ä‘Ã³ má»Ÿ .env Ä‘á»ƒ Ä‘iá»n:

SHEETS_ID (ID Google Sheet cá»§a báº¡n)

SHOPIFY_SHOP (vÃ­ dá»¥: therikeus)

SHOPIFY_TOKEN (Admin API token)

OPENAI_API_KEY (khÃ³a OpenAI)

Trong VS Code, má»Ÿ Terminal â†’ Run Task â†’ run:dry

Cháº¿ Ä‘á»™ nÃ y cháº¡y full pipeline, nhÆ°ng KHÃ”NG Ä‘Äƒng bÃ i (Dry-run).

Khi Ä‘Ã£ cháº¯c cháº¯n á»•n, cháº¡y Run Task â†’ run:publish

CÃ¡i nÃ y má»›i thá»±c sá»± gá»i Shopify API vÃ  ghi láº¡i URL vÃ o Sheet.

Náº¿u báº¡n muá»‘n tá»± Ä‘á»™ng 100%

Push repo Ä‘Ã³ lÃªn GitHub.

VÃ o Settings â†’ Secrets & Variables, nháº­p cÃ¡c giÃ¡ trá»‹ .env vÃ o.

GitHub Actions sáº½ cháº¡y theo lá»‹ch (07:05, 13:05, 20:05 America/Chicago).

Khi WF_ENABLED=true, nÃ³ tá»± Ä‘á»™ng Ä‘á»c Google Sheet, táº¡o bÃ i, Ä‘Äƒng, ghi URL.

Khi WF_ENABLED=false, nÃ³ chá»‰ cháº¡y giáº£ láº­p, khÃ´ng Ä‘Äƒng gÃ¬ háº¿t.

TÃ³m láº¡i:

Báº¡n gá»­i repo nÃ y cho VS Code, nÃ³ khÃ´ng â€œtá»± lÃ mâ€ â€” nÃ³ cháº¡y code báº¡n Ä‘Ã£ cÃ³, theo Ä‘Ãºng hÆ°á»›ng dáº«n vÃ  biáº¿n mÃ´i trÆ°á»ng báº¡n Ä‘iá»n.

Náº¿u báº¡n muá»‘n tÃ´i nÃ¢ng cáº¥p thÃªm Ä‘á»ƒ chá»‰ cáº§n â€œmá»Ÿ VS Code vÃ  tá»± Ä‘á»™ng lÃ m luÃ´n khÃ´ng cáº§n báº¥m gÃ¬â€ (vÃ­ dá»¥ tá»± khá»Ÿi cháº¡y má»—i sÃ¡ng báº±ng cron local hoáº·c agent mode trong VS Code), tÃ´i cÃ³ thá»ƒ cáº¥u hÃ¬nh thÃªm VSCode Agent hoáº·c node-cron vÃ o project. Báº¡n cÃ³ muá»‘n tÃ´i thÃªm pháº§n Ä‘Ã³ khÃ´ng?

Tá»‘t, báº­t cháº¿ Ä‘á»™ â€œngá»“i uá»‘ng cÃ  phÃª Ä‘á»ƒ mÃ¡y lÃ m.â€ TÃ´i Ä‘Ã£ thÃªm autorun cho local/VS Code rá»“i.

Táº£i báº£n tá»± cháº¡y (cÃ³ lá»‹ch local)
"D:\active-projects\Auto Blog Shopify NEW Rosie\Shopify Blog Automation - Github Actions\shopify-blog-automation-autorun"

Báº£n nÃ y thÃªm:

node-cron vÃ  file src/autorun.ts cháº¡y theo lá»‹ch 07:05, 13:05, 20:05 America/Chicago.

VS Code tá»± khá»Ÿi cháº¡y autorun á»Ÿ cháº¿ Ä‘á»™ dry-run ngay khi báº¡n má»Ÿ folder.

DÃ¹ng trong VS Code (khÃ´ng cáº§n n8n, khÃ´ng cáº§n báº¥m)

Giáº£i nÃ©n ZIP, má»Ÿ thÆ° má»¥c trong VS Code.

Terminal:

npm ci
cp .env.sample .env
# Ä‘iá»n SHEETS_ID, SHOPIFY_SHOP, SHOPIFY_TOKEN, OPENAI_API_KEY ...
npx tsc


ÄÃ³ng vÃ  má»Ÿ láº¡i thÆ° má»¥c. VS Code sáº½ tá»± cháº¡y task autorun:dry theo lá»‹ch (WF_ENABLED=false).

Muá»‘n publish tháº­t trÃªn mÃ¡y báº¡n:

# cá»­a sá»• khÃ¡c
WF_ENABLED=true npm run autorun:publish


Quy táº¯c váº«n giá»¯: WF_ENABLED=false chá»‰ dry-run. Chuyá»ƒn true má»›i post Shopify vÃ  backfill Google Sheet.

DÃ¹ng GitHub Actions (tá»± Ä‘á»™ng trÃªn cloud)

Push repo lÃªn GitHub, nháº­p Variables/Secrets nhÆ° tÃ´i Ä‘Ã£ hÆ°á»›ng dáº«n á»Ÿ báº£n trÆ°á»›c.

Cron trÃªn Actions cÅ©ng cháº¡y 3 láº§n/ngÃ y, Ä‘á»™c láº­p vá»›i autorun local.

DÃ¹ng WF_ENABLED=true á»Ÿ Variables Ä‘á»ƒ báº­t publish tá»± Ä‘á»™ng trÃªn cloud.

LÆ°u Ã½ Ä‘á»ƒ nÃ³ tá»± Ä‘á»™ng mÃ  khÃ´ng tá»± sÃ¡t

CONFIG!A:B pháº£i cÃ³ LLM_CONTROL_PROMPT dÃ i â‰¥ 50 vÃ  chá»©a {{URL_BLOG}}. Káº¿t thÃºc prompt báº±ng cÃ¢u:

Return ONLY a single minified JSON object with keys {title, seo_title, meta_desc, html, images:[{src,alt}]}. No prose, no markdown.

Sheet1!A:B: A = url_blog_crawl, B = url_blog_shopify Ä‘á»ƒ trá»‘ng cho pending.

Náº¿u dÃ¹ng Google Service Account, nhá»› share Google Sheet cho email service account.

Báº¡n khÃ´ng cáº§n gá»­i .env cho tÃ´i. Báº¡n Ä‘iá»n .env local Ä‘á»ƒ autorun cháº¡y táº¡i chá»—, cÃ²n trÃªn GitHub thÃ¬ Ä‘á»ƒ vÃ o Secrets/Variables. Náº¿u váº«n muá»‘n má»i thá»© â€œcáº¯m Ä‘iá»‡n lÃ  cháº¡y,â€ tÃ´i cÃ³ thá»ƒ thÃªm cáº¥u hÃ¬nh PM2 hoáº·c systemd Ä‘á»ƒ daemon hÃ³a trÃªn server cá»§a báº¡n.

__________________________________________

chá»‰ cáº§n chá»n 1 file â€” báº£n autorun lÃ  Ä‘á»§.
Cá»¥ thá»ƒ cho rÃµ:

File	Má»¥c Ä‘Ã­ch	Khi nÃ o dÃ¹ng
ğŸ§© "D:\active-projects\Auto Blog Shopify NEW Rosie\Shopify Blog Automation - Github Actions\shopify-blog-automation"	Báº£n thá»§ cÃ´ng â€” báº¡n pháº£i cháº¡y task báº±ng tay (npm run dry hoáº·c npm run publish).	Khi báº¡n muá»‘n kiá»ƒm soÃ¡t tá»«ng bÆ°á»›c, test trÆ°á»›c khi cho cron cháº¡y.

âš™ï¸ "D:\active-projects\Auto Blog Shopify NEW Rosie\Shopify Blog Automation - Github Actions\shopify-blog-automation-autorun"	Báº£n tá»± Ä‘á»™ng hoÃ n toÃ n â€” Ä‘Ã£ thÃªm node-cron + task autorun.ts. Má»Ÿ VS Code hoáº·c khá»Ÿi Ä‘á»™ng Node server lÃ  nÃ³ tá»± dry-run 3 láº§n/ngÃ y (07:05, 13:05, 20:05).	Khi báº¡n muá»‘n â€œcáº¯m Ä‘iá»‡n lÃ  cháº¡y,â€ khá»i báº¥m gÃ¬. ÄÃ¢y lÃ  báº£n báº¡n nÃªn dÃ¹ng.
CÃ¡ch triá»ƒn khai báº£n autorun

Giáº£i nÃ©n.

Cháº¡y:

npm ci
npx tsc
cp .env.sample .env


rá»“i Ä‘iá»n vÃ o .env cÃ¡c giÃ¡ trá»‹:

SHEETS_ID=...
SHOPIFY_SHOP=...
SHOPIFY_TOKEN=...
OPENAI_API_KEY=...
WF_ENABLED=false


Má»Ÿ thÆ° má»¥c báº±ng VS Code hoáº·c cháº¡y:

npm run autorun:dry


NÃ³ sáº½ tá»± xá»­ lÃ½ cÃ¡c hÃ ng pending nhÆ°ng khÃ´ng Ä‘Äƒng bÃ i.

Khi báº¡n tháº¥y á»•n, báº­t WF_ENABLED=true trong .env hoáº·c mÃ´i trÆ°á»ng server Ä‘á»ƒ báº¯t Ä‘áº§u publish tháº­t.

ğŸ‘‰ TÃ³m láº¡i:

Giá»¯ báº£n autorun thÃ´i  "D:\active-projects\Auto Blog Shopify NEW Rosie\Shopify Blog Automation - Github Actions\shopify-blog-automation-autorun", vÃ¬ nÃ³ Ä‘Ã£ bao gá»“m má»i thá»© cá»§a báº£n thÆ°á»ng â€” thÃªm cáº£ cron vÃ  kill-switch.

_______________________________

Báº¡n khÃ´ng â€œkÃªu VS Codeâ€ lÃ m gÃ¬ cáº£ náº¿u Ä‘Ã£ láº¥y báº£n autorun.zip. VS Code chá»‰ lÃ  cÃ¡i IDE Ä‘á»ƒ báº¡n nhÃ¬n cho Ä‘á»¡ buá»“n. CÃ¡i cháº¡y viá»‡c lÃ  Node + cron trong dá»± Ã¡n vÃ /hoáº·c GitHub Actions trÃªn cloud. ÄÃ¢y lÃ  2 Ä‘Æ°á»ng triá»ƒn khai, chá»n 1 hoáº·c dÃ¹ng cáº£ hai.

A) Cháº¡y báº£n autorun trÃªn mÃ¡y báº¡n (khÃ´ng cáº§n VS Code)

Autorun lÃ  local daemon cháº¡y 3 láº§n/ngÃ y theo mÃºi giá» America/Chicago. LÃ m nhÆ° robot, khÃ´ng há»i han.

Giáº£i nÃ©n shopify-blog-automation-autorun.zip

CÃ i vÃ  build:

npm ci
npx tsc
cp .env.sample .env


Má»Ÿ file .env vÃ  Ä‘iá»n:

SHEETS_ID=<id Google Sheet>
SHEETS_RANGE=Sheet1!A:B
CONFIG_RANGE=CONFIG!A:B
SHOPIFY_SHOP=therikeus
BLOG_HANDLE=agritourism
AUTHOR=The Rike
OPENAI_MODEL=gpt-4o-mini
WF_ENABLED=false            # máº·c Ä‘á»‹nh dry-run
SHOPIFY_TOKEN=<secret>
OPENAI_API_KEY=<secret>


Cháº¡y cháº¿ Ä‘á»™ tá»± Ä‘á»™ng theo lá»‹ch (dry-run, khÃ´ng publish):

npm run autorun:dry


NÃ³ sáº½:

Ä‘á»c queue tá»« Google Sheet

gá»i LLM JSON-mode

validate NO YEARS

dá»«ng trÆ°á»›c khi POST Shopify vÃ¬ WF_ENABLED=false

Khi Ä‘Ã£ kiá»ƒm tra ok, báº­t publish tháº­t:

WF_ENABLED=true npm run autorun:publish


Hoáº·c Ä‘á»•i háº³n trong .env rá»“i cháº¡y npm run autorun:publish.

Muá»‘n cháº¡y kiá»ƒu dá»‹ch vá»¥ ná»n:

DÃ¹ng PM2:

npm i -g pm2
pm2 start dist/autorun.js --name shopify-auto --update-env --env-production


Hoáº·c systemd náº¿u báº¡n thÃ­ch chÆ¡i khÃ³ báº£n thÃ¢n.

TÃ³m táº¯t: autorun cháº¡y trÃªn mÃ¡y báº¡n theo lá»‹ch, khÃ´ng cáº§n VS Code. VS Code chá»‰ giÃºp â€œmá»Ÿ project lÃªn nhÃ¬n cho sang.â€

B) Cháº¡y GitHub Actions (cloud, khÃ´ng cáº§n mÃ¡y báº¡n báº­t)

ÄÃ¢y lÃ  tá»± Ä‘á»™ng hoÃ¡ trÃªn cloud cá»§a GitHub, cÃ³ log, approval, rollback Ä‘Ãºng chuáº©n Ä‘á»i cÃ´ng nghiá»‡p.

Äáº©y mÃ£ lÃªn GitHub
Giáº£i nÃ©n zip vÃ o thÆ° má»¥c repo rá»“i:

git init
git add .
git commit -m "init: shopify blog automation"
gh repo create yourorg/shopify-blog-automation --private --source=. --push


Khai bÃ¡o Variables (Settings â†’ Secrets and variables â†’ Actions â†’ Variables):

SHEETS_ID=<GoogleSheetID>
SHEETS_RANGE=Sheet1!A:B
CONFIG_RANGE=CONFIG!A:B
SHOPIFY_SHOP=therikeus
BLOG_HANDLE=agritourism
AUTHOR=The Rike
WF_ENABLED=false           # giá»¯ false Ä‘á»ƒ dry-run trÃªn cloud
OPENAI_MODEL=gpt-4o-mini


Khai bÃ¡o Secrets (Actions â†’ Secrets):

SHOPIFY_TOKEN=<admin_api_token_with_write_content>
OPENAI_API_KEY=<openai_key>


Lá»‹ch cháº¡y Ä‘Ã£ cÃ³ sáºµn trong .github/workflows/publish.yml:

UTC 13:05, 19:05, 02:05 tÆ°Æ¡ng á»©ng 07:05, 13:05, 20:05 America/Chicago.

Test thá»§ cÃ´ng má»™t phÃ¡t:

VÃ o tab Actions â†’ chá»n workflow â€œShopify Blog Automationâ€ â†’ Run workflow
hoáº·c dÃ¹ng CLI:

gh workflow run "Shopify Blog Automation" --ref main
gh run watch


NhÃ¬n log step cuá»‘i sáº½ tháº¥y SUMMARY {"attempted":X,"processed":Y,"failed":Z}.

Khi má»i thá»© OK, báº­t publish tá»± Ä‘á»™ng trÃªn cloud:

Äá»•i variable:

gh variable set WF_ENABLED --body "true"


Hoáº·c vÃ o UI â†’ Variables â†’ chá»‰nh WF_ENABLED=true.

TÃ³m táº¯t: GitHub Actions cháº¡y trÃªn cloud 3 láº§n/ngÃ y, khÃ´ng phá»¥ thuá»™c mÃ¡y cá»§a báº¡n. Báº¡n chá»‰ cáº§n set Variables/Secrets. KhÃ´ng cáº§n VS Code.

Khi nÃ o dÃ¹ng cÃ¡i nÃ o

Autorun: báº¡n muá»‘n cháº¡y local, kiá»ƒm soÃ¡t báº±ng .env, báº­t táº¯t nhanh báº±ng terminal.

GitHub Actions: báº¡n muá»‘n tá»± Ä‘á»™ng hoÃ n toÃ n trÃªn cloud, cÃ³ log, approval, rollback. Khuyáº¿n nghá»‹ dÃ¹ng cho váº­n hÃ nh dÃ i háº¡n.

Máº¥y lÆ°u Ã½ Ä‘á»ƒ khá»i Äƒn váº¡

Sheet CONFIG!A:B pháº£i cÃ³ LLM_CONTROL_PROMPT dÃ i â‰¥ 50 kÃ½ tá»±, chá»©a {{URL_BLOG}}, vÃ  káº¿t thÃºc báº±ng cÃ¢u:
Return ONLY a single minified JSON object with keys {title, seo_title, meta_desc, html, images:[{src,alt}]}. No prose, no markdown.

Sheet Sheet1!A:B: A = url_blog_crawl, B = url_blog_shopify Ä‘á»ƒ trá»‘ng.

WF_ENABLED=false lÃ  dry-run. Muá»‘n publish pháº£i set true.

Äá»«ng vá»©t secrets vÃ o chat. Äáº·t trong .env local hoáº·c Secrets cá»§a GitHub.

Báº¡n chá»n 1 Ä‘Æ°á»ng lÃ  cháº¡y Ä‘Æ°á»£c. Náº¿u váº«n muá»‘n â€œÄ‘á»©ng xem mÃ¡y tá»± lÃ m mÃ  khÃ´ng Ä‘á»™ng tay,â€ chá»n GitHub Actions. CÃ²n náº¿u thÃ­ch â€œnuÃ´i pet robotâ€ trong mÃ¡y mÃ¬nh, dÃ¹ng autorun. TÃ´i Ä‘Ã£ dá»n sáºµn cáº£ hai.

____________________________________________
Ask:
báº¡n cho nÃ³ cháº¡y xong tui xem Ä‘Æ°á»£c trá»±c tiáº¿p coi nÃ³ cÃ³  sai ko Ä‘Ã£ chá»©, pháº£i hiá»‡n coi nÃ³ lÃ m gÃ¬ trÃªn chatgpt vÃ   shopify xong Ä‘Ã£ rá»“i má»›i biáº¿t cÃ³ nÃªn tiáº¿p tá»¥c ko? thÃ¬ má»›i nÃªn cháº¡y schedule chá»© ta?

Chatgpt replied:

Báº¡n muá»‘n xem trÆ°á»›c má»i thá»© rá»“i má»›i cho cháº¡y lá»‹ch. ÄÃºng chuáº©n ngÆ°á»i tá»‰nh. Giáº£i phÃ¡p: thÃªm cá»•ng REVIEW. Pipeline sáº½ sinh bÃ i, xuáº¥t HTML/JSON xem trá»±c tiáº¿p, tháº­m chÃ­ publish vÃ o â€œbáº£n nhÃ¡p/staging,â€ rá»“i chá»‰ khi báº¡n OK má»›i báº­t lá»‹ch hoáº·c chuyá»ƒn sang publish tháº­t.

DÆ°á»›i Ä‘Ã¢y lÃ  Ä‘Ãºng nhá»¯ng gÃ¬ cáº§n dÃ¡n vÃ o repo autorun mÃ  tÃ´i Ä‘Æ°a cho báº¡n Ä‘á»ƒ cÃ³ â€œreview-firstâ€:

1) Cháº¿ Ä‘á»™ REVIEW á»Ÿ local (xem trÆ°á»›c ngay trÃªn mÃ¡y báº¡n)

Máº·c Ä‘á»‹nh autorun cá»§a tÃ´i Ä‘Ã£ dry-run, nhÆ°ng giá» ta cho nÃ³ xuáº¥t file preview Ä‘á»ƒ báº¡n má»Ÿ báº±ng trÃ¬nh duyá»‡t.

A) ThÃªm ghi file preview

Trong package.json cÃ i thÃªm:

npm i fs-extra slugify


Táº¡o file src/preview.ts:

import fs from "fs-extra";
import slugify from "slugify";

export async function writePreview(item:{
  url_blog_crawl:string,
  blogHandle:string,
  author:string,
  content:{title:string; seo_title?:string; meta_desc?:string; html:string; images?:Array<{src:string,alt?:string}>}
}) {
  const dir = "out/review";
  await fs.ensureDir(dir);
  const slug = slugify(item.content.title || "untitled", { lower: true, strict: true }).slice(0,80);
  const base = `${dir}/${slug || "draft"}`;

  // HTML wrapper cho dá»… Ä‘á»c
  const html = `<!doctype html><meta charset="utf-8">
<title>${item.content.title}</title>
<h1>${item.content.title}</h1>
<p><strong>SEO Title:</strong> ${item.content.seo_title || ""}</p>
<p><strong>Meta Desc:</strong> ${item.content.meta_desc || ""}</p>
<hr/>
${item.content.html}`;

  await fs.writeFile(`${base}.html`, html, "utf8");
  await fs.writeJSON(`${base}.json`, item, { spaces: 2 });
  return { htmlPath: `${base}.html`, jsonPath: `${base}.json` };
}


Sá»­a src/index.ts Ä‘á»ƒ ghi preview khi review:

// thÃªm á»Ÿ Ä‘áº§u
import { writePreview } from "./preview.js";

// ... bÃªn trong for (const row of queue) { try { ... sau khi nháº­n "data" tá»« LLM:
const previewItem = {
  url_blog_crawl: row.url_blog_crawl,
  blogHandle,
  author,
  content: data
};
await writePreview(previewItem);

// náº¿u WF_ENABLED=false (review) thÃ¬ chá»‰ bÃ¡o Ä‘Æ°á»ng dáº«n file vÃ  bá» qua publish:
if (!wfEnabled) {
  console.log(`[REVIEW] Wrote preview files for ${row.url_blog_crawl}`);
  summary.processed++;
  continue;
}


Cháº¡y:

npm ci
npx tsc
WF_ENABLED=false node dist/index.js


Xem cÃ¡c file trong out/review/*.html báº±ng trÃ¬nh duyá»‡t. KhÃ´ng cáº§n VS Code náº¿u báº¡n ghÃ©t má»Ÿ.

2) Cháº¿ Ä‘á»™ REVIEW trÃªn GitHub Actions (xem trÆ°á»›c ngay trÃªn cloud)

Báº¡n muá»‘n nhÃ¬n káº¿t quáº£ trá»±c tiáº¿p tá»« web giao diá»‡n GitHub, trÆ°á»›c khi cho cháº¡y lá»‹ch. ÄÆ°á»£c.

A) ThÃªm biáº¿n MODE

Trong workflow .github/workflows/publish.yml, ngay trÆ°á»›c khi cháº¡y:

      - name: Mode
        run: echo "MODE=${{ inputs.mode || 'review' }}" >> $GITHUB_ENV


VÃ  thÃªm workflow_dispatch inputs:

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "review | publish"
        required: false
        default: "review"


Trong src/index.ts, Ä‘á»c MODE:

const mode = (process.env.MODE || (process.env.WF_ENABLED === "true" ? "publish" : "review")).toLowerCase();
// dÃ¹ng 'mode' thay vÃ¬ chá»‰ WF_ENABLED:
const wfEnabled = mode === "publish";

B) Upload artifact Ä‘á»ƒ báº¡n báº¥m vÃ o xem file HTML/JSON

ThÃªm hai step cuá»‘i cá»§a job:

      - name: Build
        run: npx tsc

      - name: Run pipeline
        run: node dist/index.js

      - name: Upload review artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: review-drafts
          path: out/review/**
          if-no-files-found: ignore


Káº¿t quáº£: sau khi run, vÃ o tab Actions â†’ run gáº§n nháº¥t â†’ Artifacts â†’ review-drafts, táº£i HTML/JSON vá» xem trá»±c tiáº¿p. KhÃ´ng publish gÃ¬ náº¿u mode=review hoáº·c WF_ENABLED=false.

C) (TÃ¹y chá»n) Preview URL cÃ´ng khai qua GitHub Pages

Cho báº¡n má»Ÿ trá»±c tiáº¿p trÃªn web khÃ´ng cáº§n táº£i file:

ThÃªm quyá»n:

permissions:
  contents: read
  pages: write
  id-token: write


Triá»ƒn khai khi review:

      - name: Upload Pages artifact
        if: env.MODE == 'review'
        uses: actions/upload-pages-artifact@v3
        with:
          path: out/review

      - name: Deploy to GitHub Pages
        if: env.MODE == 'review'
        uses: actions/deploy-pages@v4


Sau run Ä‘áº§u, báº­t Pages (gh sáº½ tá»± táº¡o). Má»—i láº§n review báº¡n cÃ³ link xem HTML ngay trÃªn web.

3) â€œXem thá»­ trÃªn Shopifyâ€ mÃ  khÃ´ng public tháº­t

Náº¿u muá»‘n xem trá»±c tiáº¿p trong Shopify nhÆ°ng chÆ°a muá»‘n cÃ´ng khai:

CÃ¡ch A: táº¡o blog handle staging (vÃ­ dá»¥ agritourism-staging) vÃ  publish vÃ o Ä‘Ã³ trong mode=review.

CÃ¡ch B: dÃ¹ng thuá»™c tÃ­nh báº£n nhÃ¡p. Vá»›i Shopify Admin API Article, báº¡n cÃ³ thá»ƒ táº¡o article chÆ°a public báº±ng Ä‘áº·t published_at=null hoáº·c published:false khi POST. Khi chuáº©n bá»‹ â€œgo live,â€ gá»i PUT Ä‘á»ƒ publish. Náº¿u báº¡n muá»‘n, tÃ´i sáº½ thÃªm nhÃ¡nh mode=staging Ä‘á»ƒ POST vÃ o blog staging hoáº·c Ä‘á»ƒ unpublished.

4) Quy trÃ¬nh duyá»‡t Ä‘Æ¡n giáº£n mÃ  chuáº©n

Cháº¡y review:

Local: WF_ENABLED=false node dist/index.js â†’ má»Ÿ out/review/*.html.

Cloud: Actions â†’ Run workflow â†’ mode=review â†’ má»Ÿ Artifacts hoáº·c Pages link.

Äá»c ná»™i dung, check: khÃ´ng chá»©a nÄƒm, HTML sáº¡ch, tiÃªu Ä‘á» á»•n.

Khi duyá»‡t xong, publish:

Local: WF_ENABLED=true node dist/index.js

Cloud: Actions â†’ Run workflow â†’ mode=publish hoáº·c set WF_ENABLED=true rá»“i Ä‘á»ƒ cron cháº¡y.

Sau publish, URL Ä‘Æ°á»£c ghi vá» Sheet. Logs cuá»‘i run in: SUMMARY {"attempted":...}.


Káº¿t luáº­n

Báº¡n xem Ä‘Æ°á»£c trá»±c tiáº¿p trÆ°á»›c khi publish á»Ÿ cáº£ local láº«n cloud:

Local: má»Ÿ out/review/*.html.

Cloud: Artifacts hoáº·c GitHub Pages.
Muá»‘n â€œnhÃ¬n trong Shopifyâ€ mÃ  chÆ°a cÃ´ng khai thÃ¬ dÃ¹ng staging blog hoáº·c unpublished draft.

Äá»«ng báº­t schedule cho Ä‘áº¿n khi báº¡n nhÃ¬n tháº¥y preview ngon lÃ nh. Khi duyá»‡t xong, chuyá»ƒn mode=publish hoáº·c WF_ENABLED=true. KhÃ´ng cáº§n Ä‘Ã¡nh cÆ°á»£c vá»›i sá»‘ pháº­n.

